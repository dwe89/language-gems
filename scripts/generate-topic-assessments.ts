import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

// Load environment variables
dotenv.config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

const supabase = createClient(supabaseUrl, supabaseAnonKey);

// --- Interface Definitions ---
export interface AQATopicAssessmentDefinition {
  id?: string; // Optional for creation, Supabase generates it
  title: string;
  description?: string;
  level: 'foundation' | 'higher';
  language: string;
  identifier: string;
  theme: string;
  topic: string;
  version: string;
  total_questions: number;
  time_limit_minutes: number;
  is_active: boolean;
  created_at?: string; // Optional, Supabase handles timestamp
  updated_at?: string; // Optional, Supabase handles timestamp
}

export interface AQATopicQuestionDefinition {
  id?: string; // Optional for creation, Supabase generates it
  assessment_id: string;
  question_number: number;
  question_type: string;
  title: string;
  instructions: string;
  reading_text?: string;
  marks: number;
  theme: string;
  topic: string;
  difficulty_rating: number;
  question_data: any; // Flexible for different question types
  created_at?: string; // Optional, Supabase handles timestamp
  updated_at?: string; // Optional, Supabase handles timestamp
}

// --- Language and Tier Configurations ---
const languages = [
  { code: 'es', name: 'Spanish' },
  { code: 'fr', name: 'French' },
  { code: 'de', name: 'German' }
];

const tiers = [
  { level: 'foundation', timeLimit: 45 },
  { level: 'higher', timeLimit: 60 }
];

// --- AQA Themes and Topics (full list, but we'll filter below) ---
const AQA_THEMES = [
  {
    id: 'Theme 1: People and lifestyle',
    topics: [
      'Identity and relationships with others',
      'Healthy living and lifestyle',
      'Education and work'
    ]
  },
  {
    id: 'Theme 2: Popular culture',
    topics: [
      'Free-time activities',
      'Customs, festivals and celebrations',
      'Celebrity culture'
    ]
  },
  {
    id: 'Theme 3: Communication and the world around us',
    topics: [
      'Travel and tourism, including places of interest',
      'Media and technology',
      'The environment and where people live'
    ]
  }
];

// --- Supabase Service Class (Re-integrated) ---
export class AQATopicAssessmentService {
  /**
   * Get all topic assessments by filters
   */
  async getAssessmentsByFilters(
    level: 'foundation' | 'higher',
    language: string,
    theme: string,
    topic: string
  ): Promise<AQATopicAssessmentDefinition[]> {
    try {
      const { data, error } = await supabase
        .from('aqa_topic_assessments')
        .select('*')
        .eq('level', level)
        .eq('language', language)
        .eq('theme', theme)
        .eq('topic', topic)
        .eq('is_active', true)
        .order('identifier', { ascending: true });

      if (error) {
        console.error('Error fetching topic assessments:', error);
        return [];
      }

      return data || [];
    } catch (error) {
      console.error('Error in getAssessmentsByFilters:', error);
      return [];
    }
  }

  /**
   * Get a specific topic assessment by ID
   */
  async getAssessmentById(id: string): Promise<AQATopicAssessmentDefinition | null> {
    try {
      const { data, error } = await supabase
        .from('aqa_topic_assessments')
        .select('*')
        .eq('id', id)
        .eq('is_active', true)
        .single();

      if (error) {
        console.error('Error fetching topic assessment:', error);
        return null;
      }

      return data;
    } catch (error) {
      console.error('Error in getAssessmentById:', error);
      return null;
    }
  }

  /**
   * Get questions for a specific topic assessment
   */
  async getQuestionsByAssessmentId(assessmentId: string): Promise<AQATopicQuestionDefinition[]> {
    try {
      const { data, error } = await supabase
        .from('aqa_topic_questions')
        .select('*')
        .eq('assessment_id', assessmentId)
        .order('question_number', { ascending: true });

      if (error) {
        console.error('Error fetching topic questions:', error);
        return [];
      }

      return data || [];
    } catch (error) {
      console.error('Error in getQuestionsByAssessmentId:', error);
      return [];
    }
  }

  /**
   * Get assessment by language, level, theme, topic, and identifier
   */
  async getAssessmentByIdentifier(
    language: string,
    level: 'foundation' | 'higher',
    theme: string,
    topic: string,
    identifier: string
  ): Promise<AQATopicAssessmentDefinition | null> {
    try {
      const { data, error } = await supabase
        .from('aqa_topic_assessments')
        .select('*')
        .eq('language', language)
        .eq('level', level)
        .eq('theme', theme)
        .eq('topic', topic)
        .eq('identifier', identifier)
        .eq('is_active', true)
        .single();

      if (error) {
        console.error('Error fetching topic assessment by identifier:', error);
        return null;
      }

      return data;
    } catch (error) {
      console.error('Error in getAssessmentByIdentifier:', error);
      return null;
    }
  }

  /**
   * Get all assessments for a specific theme
   */
  async getAssessmentsByTheme(
    level: 'foundation' | 'higher',
    language: string,
    theme: string
  ): Promise<AQATopicAssessmentDefinition[]> {
    try {
      const { data, error } = await supabase
        .from('aqa_topic_assessments')
        .select('*')
        .eq('level', level)
        .eq('language', language)
        .eq('theme', theme)
        .eq('is_active', true)
        .order('topic', { ascending: true })
        .order('identifier', { ascending: true });

      if (error) {
        console.error('Error fetching assessments by theme:', error);
        return [];
      }

      return data || [];
    } catch (error) {
      console.error('Error in getAssessmentsByTheme:', error);
      return [];
    }
  }

  /**
   * Get all available topics for a theme
   */
  async getTopicsForTheme(
    level: 'foundation' | 'higher',
    language: string,
    theme: string
  ): Promise<string[]> {
    try {
      const { data, error } = await supabase
        .from('aqa_topic_assessments')
        .select('topic')
        .eq('level', level)
        .eq('language', language)
        .eq('theme', theme)
        .eq('is_active', true);

      if (error) {
        console.error('Error fetching topics for theme:', error);
        return [];
      }

      // Get unique topics
      const topics = [...new Set(data?.map(item => item.topic) || [])];
      return topics.sort();
    } catch (error) {
      console.error('Error in getTopicsForTheme:', error);
      return [];
    }
  }

  /**
   * Create a new topic assessment
   */
  async createAssessment(assessment: Omit<AQATopicAssessmentDefinition, 'id' | 'created_at' | 'updated_at'>): Promise<AQATopicAssessmentDefinition | null> {
    try {
      const { data, error } = await supabase
        .from('aqa_topic_assessments')
        .insert([assessment])
        .select()
        .single();

      if (error) {
        console.error('Error creating topic assessment:', error);
        return null;
      }

      return data;
    } catch (error) {
      console.error('Error in createAssessment:', error);
      return null;
    }
  }

  /**
   * Create questions for a topic assessment
   */
  async createQuestions(questions: Omit<AQATopicQuestionDefinition, 'id' | 'created_at' | 'updated_at'>[]): Promise<boolean> {
    try {
      const { error } = await supabase
        .from('aqa_topic_questions')
        .insert(questions);

      if (error) {
        console.error('Error creating topic questions:', error);
        return false;
      }

      return true;
    } catch (error) {
      console.error('Error in createQuestions:', error);
      return false;
    }
  }
}

const assessmentService = new AQATopicAssessmentService();

/**
 * Gets the next assessment number for a given language, level, theme, and topic.
 * @param {string} language - The language code (e.g., 'es', 'fr', 'de').
 * @param {'foundation' | 'higher'} level - The difficulty level (e.g., 'foundation', 'higher').
 * @param {string} theme - The AQA theme ID.
 * @param {string} topic - The AQA topic name.
 * @returns {Promise<number>} The next available assessment number.
 */
async function getNextAssessmentNumber(language: string, level: 'foundation' | 'higher', theme: string, topic: string): Promise<number> {
  const { data: existingAssessments } = await supabase
    .from('aqa_topic_assessments')
    .select('identifier')
    .eq('language', language)
    .eq('level', level)
    .eq('theme', theme)
    .eq('topic', topic)
    .like('identifier', 'assessment-%');

  if (!existingAssessments || existingAssessments.length === 0) {
    return 1;
  }

  // Extract assessment numbers and find the highest
  const assessmentNumbers = existingAssessments
    .map(assessment => {
      const match = assessment.identifier.match(/assessment-(\d+)/);
      return match ? parseInt(match[1]) : 0;
    })
    .filter(num => num > 0);

  return assessmentNumbers.length > 0 ? Math.max(...assessmentNumbers) + 1 : 1;
}

// --- Specific Content Variations for Spanish ---
function getSpanishTopicVariations(theme: string, topic: string) {
  const variations: Record<string, Record<string, any>> = {
    'Theme 1: People and lifestyle': {
      'Identity and relationships with others': { // Existing content, unchanged
        letterMatching: [
          'Me encanta pasar tiempo con mi familia. Siempre organizamos reuniones familiares los domingos.',
          'Tengo muchos amigos de diferentes pa√≠ses. Me gusta aprender sobre sus culturas y tradiciones.',
          'Mi hermana menor y yo compartimos muchos secretos. Ella es mi mejor confidente.',
          'Mis abuelos viven cerca de nosotros. Los visitamos todas las semanas para almorzar juntos.'
        ],
        options: ['Family time', 'Cultural exchange', 'Sibling bonds', 'Grandparent visits', 'Friendship', 'Community'],
        mainText: 'Las relaciones familiares son fundamentales en la cultura espa√±ola. En mi familia, tenemos tradiciones muy importantes como las comidas dominicales donde toda la familia se re√∫ne. Mi abuela siempre prepara paella valenciana y mis primos vienen desde Valencia para estar con nosotros. Durante estas reuniones, hablamos de nuestras vidas, compartimos noticias y fortalecemos nuestros lazos familiares. Los j√≥venes espa√±oles valoramos mucho estas tradiciones porque nos ayudan a mantener nuestra identidad cultural.',
        multipleChoice: [
          { question: 'What is fundamental in Spanish culture?', options: ['A. Work relationships', 'B. Family relationships', 'C. School relationships'], correct: 'B' },
          { question: 'When does the family meet?', options: ['A. Sunday meals', 'B. Saturday evenings', 'C. Friday afternoons'], correct: 'A' },
          { question: 'What does the grandmother prepare?', options: ['A. Gazpacho', 'B. Tortilla espa√±ola', 'C. Paella valenciana'], correct: 'C' },
          { question: 'Where do the cousins come from?', options: ['A. Madrid', 'B. Valencia', 'C. Barcelona'], correct: 'B' },
          { question: 'Why do young Spaniards value these traditions?', options: ['A. They are fun', 'B. They maintain cultural identity', 'C. They are required'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'Luis', text: 'En mi familia somos muy unidos. Tengo tres hermanos y siempre nos apoyamos mutuamente. Cuando tengo problemas, hablo con mi hermana mayor porque me da buenos consejos. Los fines de semana hacemos actividades juntos como ir al cine o jugar al f√∫tbol en el parque.' },
          { name: 'Marta', text: 'Mis padres se divorciaron cuando era peque√±a, pero mantenemos una buena relaci√≥n. Vivo con mi madre durante la semana y con mi padre los fines de semana. Al principio fue dif√≠cil, pero ahora estoy acostumbrada. Lo importante es que ambos me quieren mucho.' },
          { name: 'Javier', text: 'Soy hijo √∫nico, pero no me siento solo porque tengo muchos primos. Mis t√≠os viven en la misma ciudad y nos vemos frecuentemente. Durante las vacaciones de verano, vamos todos juntos a la playa en M√°laga. Es como tener hermanos.' }
        ],
        gridQuestions: [
          { question: 'Who has three siblings?', correct: 'L' },
          { question: 'Who talks to their older sister for advice?', correct: 'L' },
          { question: 'Whose parents are divorced?', correct: 'M' },
          { question: 'Who is an only child?', correct: 'J' },
          { question: 'Who has many cousins?', correct: 'J' },
          { question: 'Who goes to M√°laga during summer holidays?', correct: 'J' }
        ],
        openResponseText: 'La estructura familiar en Espa√±a ha cambiado mucho en las √∫ltimas d√©cadas. Tradicionalmente, las familias espa√±olas eran muy grandes, con muchos hijos y varias generaciones viviendo en la misma casa. Hoy en d√≠a, las familias son m√°s peque√±as, con uno o dos hijos como m√°ximo. Muchos j√≥venes viven con sus padres hasta los treinta a√±os debido a la situaci√≥n econ√≥mica. Sin embargo, los lazos familiares siguen siendo muy fuertes y las reuniones familiares contin√∫an siendo importantes en la cultura espa√±ola.',
        openQuestions: [
          { question: 'How has the Spanish family structure changed?', expectedWords: 3, acceptableAnswers: ['families are smaller', 'fewer children now', 'smaller families today'] },
          { question: 'How many children do families have today?', expectedWords: 3, acceptableAnswers: ['one or two', 'maximum two children', 'one two maximum'] },
          { question: 'Until what age do young people live with parents?', expectedWords: 2, acceptableAnswers: ['thirty years', 'age thirty'] },
          { question: 'Why do young people stay with parents longer?', expectedWords: 3, acceptableAnswers: ['economic situation', 'financial reasons', 'economic problems'] },
          { question: 'What remains important in Spanish culture?', expectedWords: 3, acceptableAnswers: ['family meetings', 'family reunions', 'family gatherings'] }
        ],
        timeSequenceText: 'Cuando era ni√±o, viv√≠a con mis abuelos en un pueblo peque√±o de Andaluc√≠a. Ahora vivo en Madrid con mis padres y estudio en la universidad. Mi relaci√≥n con mi familia ha cambiado mucho desde entonces. Antes depend√≠a completamente de mis abuelos para todo. Actualmente soy m√°s independiente pero sigo valorando mucho el tiempo que paso con mi familia. El pr√≥ximo a√±o planeo mudarme a mi propio apartamento, pero quiero mantener el contacto frecuente con todos. En el futuro, cuando tenga mi propia familia, espero transmitir los mismos valores que aprend√≠ de mis abuelos.',
        timeEvents: [
          { event: 'Living in Madrid and studying', correct: 'N' },
          { event: 'Living with grandparents in Andalusia', correct: 'P' },
          { event: 'Being completely dependent on grandparents', correct: 'P' },
          { event: 'Planning to move to own apartment', correct: 'F' },
          { event: 'Having own family and transmitting values', correct: 'F' }
        ],
        headlines: [
          { letter: 'A', text: 'Spanish families celebrate traditional Sunday meals' },
          { letter: 'B', text: 'Young adults living with parents longer due to economy' },
          { letter: 'C', text: 'Grandparents play important role in childcare' },
          { letter: 'D', text: 'Divorce rates increase but family bonds remain strong' },
          { letter: 'E', text: 'Spanish youth value cultural identity through family' },
          { letter: 'F', text: 'Multi-generational homes becoming less common' }
        ],
        articles: [
          { text: 'Los j√≥venes espa√±oles permanecen en casa de sus padres hasta edades m√°s avanzadas debido a la crisis econ√≥mica y la falta de empleo estable.', correct: 'B' },
          { text: 'Las familias espa√±olas mantienen la tradici√≥n de las comidas dominicales como forma de fortalecer los lazos familiares y transmitir valores culturales.', correct: 'A' },
          { text: 'Aunque las tasas de divorcio han aumentado en Espa√±a, los v√≠nculos familiares siguen siendo fuertes y las familias encuentran nuevas formas de mantenerse unidas.', correct: 'D' },
          { text: 'Los abuelos espa√±oles desempe√±an un papel crucial en el cuidado de los nietos, especialmente cuando ambos padres trabajan fuera del hogar.', correct: 'C' },
          { text: 'Los j√≥venes espa√±oles consideran que mantener las tradiciones familiares es esencial para preservar su identidad cultural en un mundo globalizado.', correct: 'E' }
        ],
        completionText: 'La identidad personal se forma a trav√©s de las relaciones que establecemos con otros. En Espa√±a, la familia extendida juega un papel fundamental en el desarrollo de la personalidad de los j√≥venes. Los abuelos transmiten historias y tradiciones, los padres proporcionan apoyo emocional y econ√≥mico, y los hermanos ofrecen compa√±√≠a y comprensi√≥n. Estas relaciones m√∫ltiples ayudan a crear una identidad s√≥lida y un sentido de pertenencia a la comunidad.',
        completionSentences: [
          { incomplete: 'Personal identity is formed through _____ with others.', correct: 'relationships' },
          { incomplete: 'Extended family plays a _____ role in development.', correct: 'fundamental' },
          { incomplete: 'Grandparents transmit _____ and traditions.', correct: 'stories' },
          { incomplete: 'Parents provide emotional and _____ support.', correct: 'economic' },
          { incomplete: 'These relationships help create a sense of _____.', correct: 'belonging' }
        ],
        lifestyleText: 'El equilibrio entre la vida familiar y personal es muy importante para los espa√±oles. Muchas personas dedican tiempo espec√≠fico cada semana para estar con la familia, pero tambi√©n mantienen sus propias aficiones e intereses. Es com√∫n que los j√≥venes salgan con amigos por las tardes pero regresen a casa para cenar con la familia. Esta combinaci√≥n de independencia y conexi√≥n familiar caracteriza el estilo de vida espa√±ol moderno.',
        lifestyleQuestions: [
          { question: 'What is important for Spaniards?', options: ['A. Work-life balance', 'B. Family-personal life balance', 'C. Study-leisure balance'], correct: 'B' },
          { question: 'How much time do people dedicate to family?', options: ['A. Specific time each week', 'B. All their free time', 'C. Only weekends'], correct: 'A' },
          { question: 'When do young people go out with friends?', options: ['A. In the afternoons', 'B. In the evenings', 'C. At night only'], correct: 'B' },
          { question: 'What characterizes modern Spanish lifestyle?', options: ['A. Complete independence', 'B. Only family focus', 'C. Independence and family connection'], correct: 'C' }
        ],
        translations: [
          { es: 'Mi familia es muy unida y nos apoyamos siempre.', fr: 'Ma famille est tr√®s unie et nous nous soutenons toujours.', de: 'Meine Familie ist sehr eng verbunden und wir unterst√ºtzen uns immer.', marks: 2, questionNumber: '40.1' },
          { es: 'Tengo una relaci√≥n muy especial con mis abuelos maternos.', fr: 'J\'ai une relation tr√®s sp√©ciale avec mes grands-parents maternels.', de: 'Ich habe eine sehr besondere Beziehung zu meinen Gro√üeltern m√ºtterlicherseits.', marks: 2, questionNumber: '40.2' },
          { es: 'Los domingos toda la familia se re√∫ne para almorzar juntos.', fr: 'Le dimanche toute la famille se r√©unit pour d√©jeuner ensemble.', de: 'Sonntags versammelt sich die ganze Familie zum gemeinsamen Mittagessen.', marks: 2, questionNumber: '40.3' },
          { es: 'Mis padres me ense√±aron la importancia de los valores familiares.', fr: 'Mes parents m\'ont enseign√© l\'importance des valeurs familiales.', de: 'Meine Eltern haben mir die Wichtigkeit von Familienwerten beigebracht.', marks: 2, questionNumber: '40.4' },
          { es: 'Aunque vivo lejos, mantengo contacto diario con mi hermana.', fr: 'Bien que je vive loin, je maintiens un contact quotidien avec ma s≈ìur.', de: 'Obwohl ich weit weg lebe, halte ich t√§glichen Kontakt mit meiner Schwester.', marks: 2, questionNumber: '40.5' }
        ]
      },
      'Healthy living and lifestyle': { // Existing content, unchanged
        letterMatching: [
          'Para mantenerme en forma, hago deporte tres veces por semana. Me encanta correr en el parque.',
          'Intento comer cinco porciones de fruta y verdura al d√≠a. Mi favorita es la manzana.',
          'Es importante dormir ocho horas cada noche para tener energ√≠a y buen humor.',
          'Bebo mucha agua para mantenerme hidratado, especialmente despu√©s de hacer ejercicio.'
        ],
        options: ['Sports', 'Healthy Eating', 'Sleep', 'Hydration', 'Mindfulness', 'Relaxation'],
        mainText: 'Llevar una vida sana es esencial para los j√≥venes de hoy. Muchos adolescentes espa√±oles practican deportes como el f√∫tbol, el baloncesto o la nataci√≥n para mantenerse activos. La dieta mediterr√°nea es muy popular y se basa en el consumo de frutas, verduras, aceite de oliva y pescado. Evitar las bebidas azucaradas y la comida r√°pida es clave. Adem√°s, el bienestar mental es tan importante como la salud f√≠sica, por lo que actividades como leer o pasar tiempo con amigos son fundamentales para reducir el estr√©s.',
        multipleChoice: [
          { question: 'What is essential for young people today?', options: ['A. Playing video games', 'B. Having a healthy life', 'C. Eating fast food'], correct: 'B' },
          { question: 'Which sports are popular among Spanish teenagers?', options: ['A. Cricket and rugby', 'B. Football, basketball, and swimming', 'C. Golf and tennis'], correct: 'B' },
          { question: 'What is the Mediterranean diet based on?', options: ['A. Meat and potatoes', 'B. Sugary drinks and fast food', 'C. Fruits, vegetables, olive oil, and fish'], correct: 'C' },
          { question: 'What is important to avoid for a healthy diet?', options: ['A. Fruits and vegetables', 'B. Sugary drinks and fast food', 'C. Fish and olive oil'], correct: 'B' },
          { question: 'Why are activities like reading or spending time with friends important?', options: ['A. To get good grades', 'B. To reduce stress', 'C. To learn new languages'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'Elena', text: 'Para tener una vida equilibrada, me aseguro de estudiar y tambi√©n de hacer actividades extraescolares. Juego al tenis dos veces por semana y me ayuda a relajarme. Intento no pasar demasiado tiempo en las redes sociales.' },
          { name: 'Pablo', text: 'Mi desaf√≠o es comer de forma m√°s sana. Me encanta la comida r√°pida, pero s√© que no es buena. Mis padres est√°n intentando que comamos m√°s verduras en casa y estoy aprendiendo a cocinar platos saludables.' },
          { name: 'Sof√≠a', text: 'El estr√©s por los ex√°menes es real. Para gestionarlo, hago yoga y escucho m√∫sica tranquila. Tambi√©n es fundamental hablar con mis amigos y familia si me siento agobiada. La salud mental es una prioridad para m√≠.' }
        ],
        gridQuestions: [
          { question: 'Who plays tennis to relax?', correct: 'E' },
          { question: 'Who is trying to eat more healthily?', correct: 'P' },
          { question: 'Who likes fast food?', correct: 'P' },
          { question: 'Who manages exam stress with yoga?', correct: 'S' },
          { question: 'Who prioritises mental health?', correct: 'S' },
          { question: 'Who tries to limit time on social media?', correct: 'E' }
        ],
        openResponseText: 'El ejercicio f√≠sico es crucial para la salud. La Organizaci√≥n Mundial de la Salud recomienda que los adolescentes hagan al menos 60 minutos de actividad f√≠sica moderada a intensa cada d√≠a. Esto puede incluir deportes, caminar r√°pido, bailar o montar en bicicleta. La falta de actividad f√≠sica puede llevar a problemas de salud como la obesidad y enfermedades cardiovasculares en el futuro. Es importante encontrar una actividad que te guste para que sea m√°s f√°cil mantenerla a largo plazo.',
        openQuestions: [
          { question: 'How many minutes of physical activity are recommended daily for teenagers?', expectedWords: 2, acceptableAnswers: ['60 minutes', 'sixty minutes', 'at least 60 minutes'] },
          { question: 'Name two activities that count as physical activity.', expectedWords: 4, acceptableAnswers: ['sports and walking', 'dancing and cycling', 'sports dancing', 'walking cycling'] },
          { question: 'What health problem can lack of physical activity lead to?', expectedWords: 1, acceptableAnswers: ['obesity', 'heart disease'] },
          { question: 'Why is it important to find an activity you like?', expectedWords: 5, acceptableAnswers: ['easier to maintain long-term', 'to maintain it longer', 'easier to keep it'] },
          { question: 'What kind of physical activity is recommended?', expectedWords: 4, acceptableAnswers: ['moderate to intense', 'moderate intense'] }
        ],
        timeSequenceText: 'Cuando era peque√±o, pasaba horas jugando a videojuegos y com√≠a muchas golosinas. Era bastante sedentario. Ahora, en la adolescencia, he cambiado mis h√°bitos. Voy al gimnasio tres veces por semana y como de forma m√°s equilibrada. Mis padres me animaron a ser m√°s activo y me ayudaron a entender la importancia de la salud. El pr√≥ximo a√±o, quiero participar en una carrera solidaria de 5 km. En el futuro, espero poder inspirar a otros a adoptar un estilo de vida saludable.',
        timeEvents: [
          { event: 'Spending hours playing video games', correct: 'P' },
          { event: 'Going to the gym three times a week', correct: 'N' },
          { event: 'Planning to participate in a 5km charity run', correct: 'F' },
          { event: 'Being quite sedentary', correct: 'P' },
          { event: 'Hoping to inspire others to adopt a healthy lifestyle', correct: 'F' }
        ],
        headlines: [
          { letter: 'A', text: 'The importance of balanced meals for teenagers' },
          { letter: 'B', text: 'Mental well-being: A priority for young people' },
          { letter: 'C', text: 'How technology influences adolescent sleep patterns' },
          { letter: 'D', text: 'Teenagers opting for outdoor activities over screens' },
          { letter: 'E', text: 'Government campaigns promote healthy habits in schools' },
          { letter: 'F', text: 'The rise of plant-based diets among Spanish youth' }
        ],
        articles: [
          { text: 'Un estudio reciente muestra que m√°s j√≥venes espa√±oles eligen pasar su tiempo libre haciendo senderismo y ciclismo en lugar de usar dispositivos electr√≥nicos. Esto contribuye a un estilo de vida m√°s activo.', correct: 'D' },
          { text: 'Las nuevas iniciativas gubernamentales buscan educar a los estudiantes sobre la importancia de la nutrici√≥n y el ejercicio a trav√©s de talleres y programas deportivos en los colegios.', correct: 'E' },
          { text: 'Muchos adolescentes espa√±oles est√°n adoptando dietas vegetarianas y veganas, lo que se considera un paso positivo hacia una alimentaci√≥n m√°s consciente y sostenible.', correct: 'F' },
          { text: 'Expertos en salud mental subrayan la necesidad de abordar el estr√©s y la ansiedad en los j√≥venes, promoviendo actividades que fomenten la relajaci√≥n y el equilibrio emocional.', correct: 'B' },
          { text: 'La calidad del sue√±o en adolescentes se ve afectada por el uso excesivo de tel√©fonos m√≥viles antes de dormir, lo que impacta negativamente su rendimiento acad√©mico y su estado de √°nimo.', correct: 'C' }
        ],
        completionText: 'Una alimentaci√≥n equilibrada es fundamental para el crecimiento y desarrollo de los adolescentes. Incluir una variedad de frutas, verduras, prote√≠nas y cereales integrales proporciona la energ√≠a necesaria para el estudio y el deporte. Evitar los alimentos ultraprocesados y las bebidas con alto contenido de az√∫car es clave para prevenir problemas de salud a largo plazo como la diabetes tipo 2. Es importante que los j√≥venes aprendan a tomar decisiones saludables para su bienestar futuro.',
        completionSentences: [
          { incomplete: 'A balanced diet is _____ for growth and development.', correct: 'fundamental' },
          { incomplete: 'It provides the necessary _____ for studying and sports.', correct: 'energy' },
          { incomplete: 'Avoiding ultra-processed foods helps _____ long-term health issues.', correct: 'prevent' },
          { incomplete: 'Sugary drinks can lead to problems like Type 2 _____.', correct: 'diabetes' },
          { incomplete: 'Young people should learn to make _____ choices.', correct: 'healthy' }
        ],
        lifestyleText: 'El estilo de vida saludable no solo se trata de la alimentaci√≥n y el ejercicio, sino tambi√©n del bienestar mental. En Espa√±a, los j√≥venes est√°n cada vez m√°s conscientes de la importancia de cuidar su salud mental. Actividades como la meditaci√≥n, pasar tiempo en la naturaleza o practicar un hobby ayudan a reducir el estr√©s. Es un enfoque hol√≠stico que combina la buena alimentaci√≥n, la actividad f√≠sica y la salud emocional para una vida plena.',
        lifestyleQuestions: [
          { question: 'What does a healthy lifestyle include besides diet and exercise?', options: ['A. Financial stability', 'B. Mental well-being', 'C. Career success'], correct: 'B' },
          { question: 'What are Spanish youth increasingly aware of?', options: ['A. The latest fashion trends', 'B. The importance of mental health', 'C. New technologies'], correct: 'B' },
          { question: 'Name one activity that helps reduce stress.', options: ['A. Playing violent video games', 'B. Meditation', 'C. Eating unhealthy snacks'], correct: 'B' },
          { question: 'What kind of approach is it for a full life?', options: ['A. A physical approach', 'B. A financial approach', 'C. A holistic approach'], correct: 'C' },
          { question: 'How can teenagers find balance between study and leisure?', options: ['A. By only focusing on academics', 'B. By combining both effectively', 'C. By ignoring extracurriculars'], correct: 'B' } // Added question
        ],
        translations: [
          { es: 'Para mantenerme sano, hago deporte regularmente.', fr: 'Pour rester en bonne sant√©, je fais du sport r√©guli√®rement.', de: 'Um gesund zu bleiben, treibe ich regelm√§√üig Sport.', marks: 2, questionNumber: '40.1' },
          { es: 'Comer frutas y verduras es muy importante.', fr: 'Manger des fruits et l√©gumes est tr√®s important.', de: 'Obst und Gem√ºse zu essen ist sehr wichtig.', marks: 2, questionNumber: '40.2' },
          { es: 'Duermo ocho horas cada noche para tener energ√≠a.', fr: 'Je dors huit horas chaque nuit pour avoir de l\'√©nergie.', de: 'Ich schlafe acht Stunden pro Nacht, um Energie zu haben.', marks: 2, questionNumber: '40.3' },
          { es: 'Evito la comida r√°pida y las bebidas azucaradas.', fr: 'J\'√©vite la restauration rapide et les boissons sucr√©es.', de: 'Ich vermeide Fast Food und zuckerhaltige Getr√§nke.', marks: 2, questionNumber: '40.4' },
          { es: 'La salud mental es tan importante como la f√≠sica.', fr: 'La sant√© mentale es tan importante como la salud f√≠sica.', de: 'Mentale Gesundheit ist genauso wichtig wie k√∂rperliche Gesundheit.', marks: 2, questionNumber: '40.5' }
        ]
      },
      'Education and work': { // NEW CONTENT FOR EDUCATION AND WORK
        letterMatching: [
          'Estoy en el √∫ltimo a√±o de secundaria y estoy pensando en ir a la universidad para estudiar ingenier√≠a.',
          'Mi hermano mayor decidi√≥ no ir a la universidad; √©l est√° haciendo un aprendizaje para ser electricista.',
          'Despu√©s de clase, tengo un trabajo a tiempo parcial en una cafeter√≠a para ganar algo de dinero extra.',
          'Los ex√°menes finales de este a√±o son muy importantes para mi futuro acad√©mico y profesional.'
        ],
        options: ['University', 'Apprenticeship', 'Part-time job', 'Exams', 'Career choices', 'Studying abroad'],
        mainText: 'En Espa√±a, la educaci√≥n secundaria obligatoria termina a los 16 a√±os. Despu√©s, los estudiantes pueden elegir entre el Bachillerato, que los prepara para la universidad, o la Formaci√≥n Profesional, que ofrece habilidades para un oficio espec√≠fico. Muchos j√≥venes tambi√©n combinan sus estudios con trabajos a tiempo parcial para ganar experiencia y dinero. La elecci√≥n de una carrera es una decisi√≥n importante, influenciada por intereses personales y oportunidades laborales. El mercado de trabajo en Espa√±a valora cada vez m√°s las habilidades pr√°cticas y los idiomas.',
        multipleChoice: [
          { question: 'What age does compulsory secondary education end in Spain?', options: ['A. 14', 'B. 16', 'C. 18'], correct: 'B' },
          { question: 'What does Bachillerato prepare students for?', options: ['A. A specific trade', 'B. University', 'C. A part-time job'], correct: 'B' },
          { question: 'Why do many young people combine studies with part-time jobs?', options: ['A. To avoid studying', 'B. To gain experience and money', 'C. To meet new friends'], correct: 'B' },
          { question: 'What influences career choice?', options: ['A. Only job opportunities', 'B. Only personal interests', 'C. Personal interests and job opportunities'], correct: 'C' },
          { question: 'What does the Spanish job market increasingly value?', options: ['A. Only academic degrees', 'B. Practical skills and languages', 'C. Only family connections'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'Andrea', text: 'Termin√© el Bachillerato el a√±o pasado y ahora estoy estudiando ADE en la universidad. Es dif√≠cil pero muy interesante. Adem√°s, hago pr√°cticas en una empresa por las ma√±anas.' },
          { name: 'Marco', text: 'No me gustaba mucho estudiar, as√≠ que despu√©s de la ESO empec√© un grado medio de mec√°nica. Me encanta aprender cosas pr√°cticas y ya tengo una oferta de trabajo para cuando termine.' },
          { name: 'Laura', text: 'Todav√≠a estoy en el instituto. Mis padres quieren que vaya a la universidad, pero yo no estoy segura. Me gustar√≠a tomarme un a√±o sab√°tico para viajar y luego decidir qu√© hacer.' }
        ],
        gridQuestions: [
          { question: 'Who is doing an internship?', correct: 'A' },
          { question: 'Who prefers practical learning?', correct: 'M' },
          { question: 'Who is thinking about taking a gap year?', correct: 'L' },
          { question: 'Who has a job offer after finishing their studies?', correct: 'M' },
          { question: 'Who is studying at university?', correct: 'A' },
          { question: 'Whose parents want them to go to university?', correct: 'L' }
        ],
        openResponseText: 'El desempleo juvenil es un desaf√≠o importante en Espa√±a. Muchos j√≥venes tienen dificultades para encontrar su primer trabajo despu√©s de terminar los estudios. El gobierno y varias organizaciones est√°n creando programas de formaci√≥n y pr√°cticas para ayudar a los j√≥venes a adquirir la experiencia necesaria. Tambi√©n se promueve el emprendimiento como una opci√≥n viable. Adaptarse a las nuevas tecnolog√≠as y ser flexible son habilidades clave para el √©xito en el mercado laboral actual.',
        openQuestions: [
          { question: 'What is a significant challenge for young people in Spain?', expectedWords: 3, acceptableAnswers: ['youth unemployment', 'youth unemployment is a challenge', 'unemployment is a challenge'] },
          { question: 'What are governments and organizations creating to help young people?', expectedWords: 5, acceptableAnswers: ['training and internship programs', 'programs for training and internships', 'training programs and internships'] },
          { question: 'What is also promoted as a viable option?', expectedWords: 1, acceptableAnswers: ['entrepreneurship'] },
          { question: 'Name two key skills for success in today\'s job market.', expectedWords: 4, acceptableAnswers: ['new technologies and flexibility', 'adapting to new technologies being flexible', 'flexibility and new technologies'] },
          { question: 'What do many young people struggle to find after finishing studies?', expectedWords: 3, acceptableAnswers: ['their first job', 'a first job'] }
        ],
        timeSequenceText: 'Cuando era ni√±o, siempre so√±aba con ser futbolista profesional, pero no era muy bueno. En la escuela primaria, me encantaban las matem√°ticas y la inform√°tica. Ahora, estoy en mi √∫ltimo a√±o de instituto y estoy solicitando plaza en varias universidades para estudiar desarrollo de software. Me han ofrecido una beca para estudiar en Alemania el pr√≥ximo a√±o, lo cual es muy emocionante. En el futuro, espero trabajar en una gran empresa tecnol√≥gica y crear aplicaciones innovadoras.',
        timeEvents: [
          { event: 'Dreaming of being a professional footballer', correct: 'P' },
          { event: 'Applying for university places', correct: 'N' },
          { event: 'Being offered a scholarship to study in Germany', correct: 'N' },
          { event: 'Hoping to work in a big tech company', correct: 'F' },
          { event: 'Loving maths and IT in primary school', correct: 'P' }
        ],
        headlines: [
          { letter: 'A', text: 'New vocational training programs for young Spaniards' },
          { letter: 'B', text: 'Digital skills key for employment in Spain' },
          { letter: 'C', text: 'Youth unemployment remains a challenge' },
          { letter: 'D', text: 'Spanish students choose abroad for higher education' },
          { letter: 'E', text: 'Importance of internships for career development' },
          { letter: 'F', text: 'Entrepreneurship gaining popularity among youth' }
        ],
        articles: [
          { text: 'El n√∫mero de j√≥venes espa√±oles que optan por programas de formaci√≥n profesional ha aumentado significativamente, buscando inserci√≥n laboral r√°pida.', correct: 'A' },
          { text: 'A pesar de los esfuerzos, la tasa de desempleo entre los menores de 25 a√±os sigue siendo una preocupaci√≥n principal para el gobierno.', correct: 'C' },
          { text: 'Cada vez m√°s estudiantes espa√±oles consideran ir al extranjero para sus estudios universitarios, buscando nuevas experiencias y oportunidades.', correct: 'D' },
          { text: 'La capacidad de adaptarse a las nuevas tecnolog√≠as y poseer habilidades digitales avanzadas son requisitos indispensables en el mercado laboral actual.', correct: 'B' },
          { text: 'Las pr√°cticas en empresas se consideran esenciales para que los reci√©n graduados adquieran experiencia y aumenten sus posibilidades de encontrar un buen empleo.', correct: 'E' }
        ],
        completionText: 'La tecnolog√≠a ha transformado el mundo del trabajo y la educaci√≥n. El aprendizaje en l√≠nea se ha vuelto m√°s accesible, permitiendo a los estudiantes adquirir nuevas habilidades desde casa. Sin embargo, tambi√©n presenta desaf√≠os, como la necesidad de autodisciplina. En el futuro, la inteligencia artificial podr√≠a cambiar a√∫n m√°s las profesiones, haciendo que la adaptaci√≥n continua y la formaci√≥n a lo largo de toda la vida sean esenciales para todos los trabajadores.',
        completionSentences: [
          { incomplete: 'Technology has transformed the world of work and _____.', correct: 'education' },
          { incomplete: 'Online learning has become more _____.', correct: 'accessible' },
          { incomplete: 'It allows students to acquire new skills from _____.', correct: 'home' },
          { incomplete: 'Continuous _____ and lifelong learning will be essential.', correct: 'adaptation' },
          { incomplete: 'Artificial intelligence could change _____ even more.', correct: 'professions' }
        ],
        lifestyleText: 'La orientaci√≥n profesional es una etapa clave para los j√≥venes. Elegir la buena v√≠a requiere conocerse bien y informarse sobre las diferentes oportunidades. Los salones estudiantiles y los consejeros de orientaci√≥n juegan un papel importante para guiar a los alumnos. Tambi√©n es beneficioso hablar con profesionales para entender la realidad de los oficios. Un proyecto profesional bien definido aumenta las posibilidades de √©xito en el recorrido educativo y la carrera.',
        lifestyleQuestions: [
          { question: 'What is a key step for young people?', options: ['A. Traveling', 'B. Career guidance', 'C. Learning to drive'], correct: 'B' },
          { question: 'What is important when choosing the right path?', options: ['A. Knowing many people', 'B. Knowing yourself and getting informed', 'C. Having a lot of money'], correct: 'B' },
          { question: 'Who plays an important role in guiding students?', options: ['A. Famous celebrities', 'B. Student fairs and career counselors', 'C. Sports coaches'], correct: 'B' },
          { question: 'What does talking with professionals help to understand?', options: ['A. Their personal lives', 'B. The reality of jobs', 'C. How to make friends'], correct: 'B' },
          { question: 'What increases chances of success in education and career?', options: ['A. A rich family', 'B. A well-defined career plan', 'C. Only good luck'], correct: 'B' }
        ],
        translations: [
          { es: 'Para ir a la universidad, necesito buenas notas.', fr: 'Pour aller √† l\'universit√©, j\'ai besoin de bonnes notes.', de: 'Um an die Universit√§t zu gehen, brauche ich gute Noten.', marks: 2, questionNumber: '41.1' },
          { es: 'Quiero hacer un aprendizaje despu√©s del instituto.', fr: 'Je veux faire un apprentissage apr√®s le lyc√©e.', de: 'Ich m√∂chte nach der Schule eine Ausbildung machen.', marks: 2, questionNumber: '41.2' },
          { es: 'Mi trabajo a tiempo parcial es en una tienda.', fr: 'Mon travail √† temps partiel est dans un magasin.', de: 'Mein Nebenjob ist in einem Gesch√§ft.', marks: 2, questionNumber: '41.3' },
          { es: 'Los idiomas son muy importantes para mi futura carrera.', fr: 'Les langues sont muy importantes pour ma future carri√®re.', de: 'Sprachen sind sehr wichtig f√ºr meine zuk√ºnftige Karriere.', marks: 2, questionNumber: '41.4' },
          { es: 'El desempleo juvenil es un problema serio.', fr: 'Le ch√¥mage des jeunes est un probl√®me s√©rieux.', de: 'Jugendarbeitslosigkeit ist ein ernstes Problem.', marks: 2, questionNumber: '41.5' }
        ]
      }
    }
  };

  const themeData = variations[theme];
  if (!themeData) {
    console.warn(`No specific variations found for theme: ${theme} - using default Spanish.`);
    return getDefaultSpanishVariations();
  }
  const topicData = themeData[topic];
  if (!topicData) {
    console.warn(`No specific variations found for topic: ${topic} under theme ${theme} - using default Spanish.`);
    return getDefaultSpanishVariations();
  }
  return topicData;
}

// --- Default Spanish Content for Fallback ---
function getDefaultSpanishVariations() {
  return {
    letterMatching: [
      'Me gusta hacer actividades diferentes en mi tiempo libre.',
      'Practico deportes con mis amigos los fines de semana.',
      'Leo libros interesantes en la biblioteca municipal.',
      'Escucho m√∫sica mientras hago mis tareas escolares.'
    ],
    options: ['Sports', 'Reading', 'Music', 'Art', 'Gaming', 'Cooking'],
    mainText: 'Este es un texto de ejemplo para evaluaciones tem√°ticas.',
    multipleChoice: [
      { question: 'Sample question?', options: ['A. Option 1', 'B. Option 2', 'C. Option 3'], correct: 'A' }
    ],
    studentGrid: [
      { name: 'Student1', text: 'Sample text 1' },
      { name: 'Student2', text: 'Sample text 2' },
      { name: 'Student3', text: 'Sample text 3' }
    ],
    gridQuestions: [
      { question: 'Sample question?', correct: 'A' }
    ],
    openResponseText: 'Sample open response text.',
    openQuestions: [
      { question: 'Sample question?', expectedWords: 2, acceptableAnswers: ['sample answer'] }
    ],
    timeSequenceText: 'Sample time sequence text.',
    timeEvents: [
      { event: 'Sample event', correct: 'P' }
    ],
    headlines: [
      { letter: 'A', text: 'Sample headline' }
    ],
    articles: [
      { text: 'Sample article text.', correct: 'A' }
    ],
    completionText: 'Sample completion text.',
    completionSentences: [
      { incomplete: 'Sample _____ sentence.', correct: 'completion' }
    ],
    lifestyleText: 'Sample lifestyle text.',
    lifestyleQuestions: [
      { question: 'Sample question?', options: ['A. Option 1', 'B. Option 2', 'C. Option 3'], correct: 'A' }
    ],
    translations: [
      { es: 'Ejemplo de traducci√≥n.', fr: 'Exemple de traducci√≥n.', de: 'Beispiel f√ºr √úbersetzung.', marks: 2, questionNumber: '40.1' }
    ]
  };
}

/**
 * Generates Spanish topic questions for a specific topic - ALL 40 QUESTIONS
 * @param {string} theme - The AQA theme ID.
 * @param {string} topic - The AQA topic name.
 * @param {string} assessmentId - The ID of the assessment this question belongs to.
 * @param {'foundation' | 'higher'} level - The difficulty level ('foundation' or 'higher').
 * @returns {Array<AQATopicQuestionDefinition>} An array of question objects.
 */
function generateSpanishTopicQuestions(theme: string, topic: string, assessmentId: string, level: 'foundation' | 'higher'): AQATopicQuestionDefinition[] {
  // Topic-specific content variations
  const topicVariations = getSpanishTopicVariations(theme, topic);

  return [
    // Questions 1-4: Letter Matching - Topic-focused hobbies (4 marks)
    {
      question_number: 1,
      question_type: 'letter-matching',
      title: `Questions 1-4: ${topic} - Activities and interests`,
      instructions: `Some Spanish teenagers are talking about activities related to ${topic.toLowerCase()}. Which activity does each person mention? Write the correct letter in each box.`,
      marks: 4,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        students: [
          { name: 'Ana', text: topicVariations.letterMatching[0] },
          { name: 'Carlos', text: topicVariations.letterMatching[1] },
          { name: 'Mar√≠a', text: topicVariations.letterMatching[2] },
          { name: 'Diego', text: topicVariations.letterMatching[3] }

        ],
        options: [
          { letter: 'A', subject: topicVariations.options[0] }, // Matches letterMatching[0]
          { letter: 'B', subject: topicVariations.options[1] }, // Matches letterMatching[1]
          { letter: 'C', subject: topicVariations.options[2] }, // Matches letterMatching[2]
          { letter: 'D', subject: topicVariations.options[3] }, // Matches letterMatching[3]
          { letter: 'E', subject: topicVariations.options[4] },
          { letter: 'F', subject: topicVariations.options[5] }
        ],
        // Shuffled answers
        correctAnswers: { 'Ana': 'A', 'Carlos': 'D', 'Mar√≠a': 'B', 'Diego': 'C' }
      }
    },

    // Questions 5-9: Multiple Choice - Topic-focused reading (5 marks)
    {
      question_number: 5,
      question_type: 'multiple-choice',
      title: `Questions 5-9: ${topic}`,
      instructions: `You read this extract about ${topic.toLowerCase()}. Answer the questions by selecting the correct option.`,
      reading_text: topicVariations.mainText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.multipleChoice
      }
    },

    // Questions 10-15: Student Grid - Topic-focused activities (6 marks)
    {
      question_number: 10,
      question_type: 'student-grid',
      title: `Questions 10-15: ${topic} - Student experiences`,
      instructions: `You see an online forum. Some Spanish students are discussing ${topic.toLowerCase()}. Answer the following questions. Write E for Elena, P for Pablo, S for Sof√≠a.`, // Updated names
      marks: 6,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        students: ['E', 'P', 'S'], // Updated names
        studentTexts: topicVariations.studentGrid,
        questions: topicVariations.gridQuestions
      }
    },

    // Questions 16-20: Open Response - Topic-focused article (5 marks)
    {
      question_number: 16,
      question_type: 'open-response',
      title: `Questions 16-20: ${topic} in Spain`,
      instructions: `You read this extract from an article about ${topic.toLowerCase()} in Spain. Answer the following questions in English.`,
      reading_text: topicVariations.openResponseText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.openQuestions
      }
    },

    // Questions 21-25: Time Sequence - Topic-focused interview (5 marks)
    {
      question_number: 21,
      question_type: 'time-sequence',
      title: `Questions 21-25: Interview about ${topic}`,
      instructions: `A Spanish person talks about their experience with ${topic.toLowerCase()}. When do these events happen according to the article? Write P for something that happened in the past, N for something that is happening now, F for something that is going to happen in the future.`,
      reading_text: topicVariations.timeSequenceText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        events: topicVariations.timeEvents
      }
    },

    // Questions 26-30: Headline Matching - Topic-focused news (5 marks)
    {
      question_number: 26,
      question_type: 'headline-matching',
      title: `Questions 26-30: News headlines about ${topic}`,
      instructions: `Match each news article extract with the correct headline. Write the correct letter in each box.`,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        headlines: topicVariations.headlines,
        articles: topicVariations.articles
      }
    },

    // Questions 31-35: Sentence Completion - Topic-focused article (5 marks)
    {
      question_number: 31,
      question_type: 'sentence-completion',
      title: `Questions 31-35: ${topic}`,
      instructions: `Complete the sentences based on the text. Write the missing words in English.`,
      reading_text: topicVariations.completionText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        sentences: topicVariations.completionSentences
      }
    },

    // Questions 36-40: Multiple Choice - Topic-focused lifestyle (5 marks)
    {
      question_number: 36,
      question_type: 'multiple-choice',
      title: `Questions 36-40: ${topic} and lifestyle`,
      instructions: `Read this article about ${topic.toLowerCase()}. Answer the questions by selecting the correct option.`,
      reading_text: topicVariations.lifestyleText,
      marks: 5, // Changed from 4 to 5 marks
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.lifestyleQuestions
      }
    },

    // Question 41: Translation - Topic-focused sentences (10 marks)
    {
      question_number: 41, // Changed from 40 to 41
      question_type: 'translation',
      title: `Question 41: Translation about ${topic}`, // Changed from 40 to 41
      instructions: `Translate these sentences about ${topic.toLowerCase()} into English.`,
      marks: 10,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        // Updated to use spread operator
        sentences: topicVariations.translations.map((t: any, i: number) => ({
          ...t, // This ensures all language properties (es, fr, de) are included
          questionNumber: `41.${i + 1}` // Changed from 40 to 41
        }))
      }
    }
  ];
}

// --- Specific Content Variations for French ---
function getFrenchTopicVariations(theme: string, topic: string) {
  const variations: Record<string, Record<string, any>> = {
    'Theme 1: People and lifestyle': {
      'Identity and relationships with others': { // Existing content, unchanged
        letterMatching: [
          'J\'adore passer du temps avec ma famille. Nous organisons toujours des r√©unions familiales le dimanche.',
          'J\'ai beaucoup d\'amis de diff√©rents pays. J\'aime apprendre sur leurs cultures et traditions.',
          'Ma petite s≈ìur et moi partageons beaucoup de secrets. Elle est ma meilleure confidente.',
          'Mes grands-parents habitent pr√®s de chez nous. Nous leur rendons visite chaque semaine pour d√©jeuner ensemble.'
        ],
        options: ['Family time', 'Cultural exchange', 'Sibling bonds', 'Grandparent visits', 'Friendship', 'Community'],
        mainText: 'Les relations familiales sont fondamentales dans la culture fran√ßaise. Dans ma famille, nous avons des traditions tr√®s importantes comme les repas dominicaux o√π toute la famille se r√©unit. Ma grand-m√®re pr√©pare toujours un pot-au-feu traditionnel et mes cousins viennent de Lyon pour √™tre avec nous. Pendant ces r√©unions, nous parlons de nos vies, partageons des nouvelles et renfor√ßons nos liens familiaux. Les jeunes Fran√ßais valorisent beaucoup ces traditions car elles nous aident √† maintenir notre identit√© culturelle.',
        multipleChoice: [
          { question: 'What is fundamental in French culture?', options: ['A. Work relationships', 'B. Family relationships', 'C. School relationships'], correct: 'B' },
          { question: 'When does the family meet?', options: ['A. Sunday meals', 'B. Saturday evenings', 'C. Friday afternoons'], correct: 'A' },
          { question: 'What does the grandmother prepare?', options: ['A. Ratatouille', 'B. Pot-au-feu', 'C. Bouillabaisse'], correct: 'B' },
          { question: 'Where do the cousins come from?', options: ['A. Paris', 'B. Lyon', 'C. Marseille'], correct: 'B' },
          { question: 'Why do young French people value these traditions?', options: ['A. They are fun', 'B. They maintain cultural identity', 'C. They are required'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'Lucie', text: 'Dans ma famille nous sommes tr√®s unis. J\'ai trois fr√®res et nous nous soutenons toujours mutuellement. Quand j\'ai des probl√®mes, je parle avec mon fr√®re a√Æn√© car il me donne de bons conseils. Les week-ends nous faisons des activit√©s ensemble comme aller au cin√©ma ou jouer au football dans le parc.' },
          { name: 'Marc', text: 'Mes parents ont divorc√© quand j\'√©tais petit, mais nous maintenons une bonne relation. Je vis avec ma m√®re pendant la semaine et avec mon p√®re les week-ends. Au d√©but c\'√©tait difficile, mais maintenant je suis habitu√©. L\'important c\'est qu\'ils m\'aiment tous les deux beaucoup.' },
          { name: 'Isabelle', text: 'Je suis fille unique, mais je ne me sens pas seule car j\'ai beaucoup de cousins. Mes oncles et tantes habitent dans la m√™me ville et nous nous voyons fr√©quemment. Pendant les vacances d\'√©t√©, nous allons tous ensemble √† la plage √† Nice. C\'est comme avoir des fr√®res et s≈ìurs.' }
        ],
        gridQuestions: [
          { question: 'Who has three brothers?', correct: 'L' },
          { question: 'Who talks to their older brother for advice?', correct: 'L' },
          { question: 'Whose parents are divorced?', correct: 'M' },
          { question: 'Who is an only child?', correct: 'I' },
          { question: 'Who has many cousins?', correct: 'I' },
          { question: 'Who goes to Nice during summer holidays?', correct: 'I' }
        ],
        openResponseText: 'La structure familiale en France a beaucoup chang√© au cours des derni√®res d√©cennies. Traditionnellement, les familles fran√ßaises √©taient assez grandes, avec plusieurs enfants et parfois plusieurs g√©n√©rations vivant dans la m√™me maison. Aujourd\'hui, les familles sont plus petites, avec un ou deux enfants au maximum. Beaucoup de jeunes vivent chez leurs parents jusqu\'√† vingt-cinq ans en raison de la situation √©conomique. Cependant, les liens familiaux restent tr√®s forts et les r√©unions familiales continuent d\'√™tre importantes dans la culture fran√ßaise.',
        openQuestions: [
          { question: 'How has the French family structure changed?', expectedWords: 3, acceptableAnswers: ['families are smaller', 'fewer children now', 'smaller families today'] },
          { question: 'How many children do families have today?', expectedWords: 3, acceptableAnswers: ['one or two', 'maximum two children', 'one two maximum'] },
          { question: 'Until what age do young people live with parents?', expectedWords: 3, acceptableAnswers: ['twenty-five years', 'age twenty-five', 'until 25'] },
          { question: 'Why do young people stay with parents longer?', expectedWords: 3, acceptableAnswers: ['economic situation', 'financial reasons', 'economic problems'] },
          { question: 'What remains important in French culture?', expectedWords: 3, acceptableAnswers: ['family meetings', 'family reunions', 'family gatherings'] }
        ],
        timeSequenceText: 'Quand j\'√©tais enfant, je vivais avec mes grands-parents dans un petit village de Provence. Maintenant je vis √† Paris avec mes parents et j\'√©tudie √† l\'universit√©. Ma relation avec ma famille a beaucoup chang√© depuis. Avant je d√©pendais compl√®tement de mes grands-parents pour tout. Actuellement je suis plus ind√©pendant mais je continue √† valoriser beaucoup le temps que je passe avec ma famille. L\'ann√©e prochaine je pr√©vois de d√©m√©nager dans mon propre appartement, mais je veux maintenir un contact fr√©quent avec tous. √Ä l\'avenir, quand j\'aurai ma propre famille, j\'esp√®re transmettre les m√™mes valeurs que j\'ai apprises de mes grands-parents.',
        timeEvents: [
          { event: 'Living in Paris and studying', correct: 'N' },
          { event: 'Living with grandparents in Provence', correct: 'P' },
          { event: 'Being completely dependent on grandparents', correct: 'P' },
          { event: 'Planning to move to own apartment', correct: 'F' },
          { event: 'Having own family and transmitting values', correct: 'F' }
        ],
        headlines: [
          { letter: 'A', text: 'French families celebrate traditional Sunday meals' },
          { letter: 'B', text: 'Young adults living with parents longer due to economy' },
          { letter: 'C', text: 'Grandparents play important role in childcare' },
          { letter: 'D', text: 'Divorce rates increase but family bonds remain strong' },
          { letter: 'E', text: 'French youth value cultural identity through family' },
          { letter: 'F', text: 'Multi-generational homes becoming less common' }
        ],
        articles: [
          { text: 'Les jeunes Fran√ßais restent chez leurs parents jusqu\'√† des √¢ges plus avanc√©s en raison de la crise √©conomique et du manque d\'emploi stable.', correct: 'B' },
          { text: 'Les familles fran√ßaises maintiennent la tradition des repas dominicaux comme moyen de renforcer les liens familiaux et de transmettre les valeurs culturelles.', correct: 'A' },
          { text: 'Bien que les taux de divorce aient augment√© en France, les liens familiaux restent forts et les familles trouvent de nouvelles fa√ßons de rester unies.', correct: 'D' },
          { text: 'Les grands-parents fran√ßais jouent un r√¥le crucial dans la garde des petits-enfants, surtout quand les deux parents travaillent √† l\'ext√©rieur.', correct: 'C' },
          { text: 'Les jeunes Fran√ßais consid√®rent que maintenir les traditions familiales est essentiel pour pr√©server leur identit√© culturelle dans un monde globalis√©.', correct: 'E' }
        ],
        completionText: 'L\'identit√© personnelle se forme √† travers les relations que nous √©tablissons avec les autres. En France, la famille √©largie joue un r√¥le fondamental dans le d√©veloppement de la personnalit√© des jeunes. Les grands-parents transmettent des histoires et des traditions, les parents fournissent un soutien √©motionnel et √©conomique, et les fr√®res et s≈ìurs offrent de la compagnie et de la compr√©hension. Ces relations multiples aident √† cr√©er une identit√© solide et un sentiment d\'appartenance √† la communaut√©.',
        completionSentences: [
          { incomplete: 'Personal identity is formed through _____ with others.', correct: 'relationships' },
          { incomplete: 'Extended family plays a _____ role in development.', correct: 'fundamental' },
          { incomplete: 'Grandparents transmit _____ and traditions.', correct: 'stories' },
          { incomplete: 'Parents provide emotional and _____ support.', correct: 'economic' },
          { incomplete: 'These relationships help create a sense of _____.', correct: 'belonging' }
        ],
        lifestyleText: 'L\'√©quilibre entre la vie familiale et personnelle est tr√®s important pour les Fran√ßais. Beaucoup de personnes consacrent du temps sp√©cifique chaque semaine pour √™tre avec la famille, mais maintiennent aussi leurs propres loisirs et int√©r√™ts. Il est courant que les jeunes sortent avec des amis dans l\'apr√®s-midi mais rentrent √† la maison pour d√Æner avec la famille. Cette combinaison d\'ind√©pendance et de connexion familiale caract√©rise le style de vie fran√ßais moderne.',
        lifestyleQuestions: [
          { question: 'What is important for French people?', options: ['A. Work-life balance', 'B. Family-personal life balance', 'C. Study-leisure balance'], correct: 'B' },
          { question: 'How much time do people dedicate to family?', options: ['A. Specific time each week', 'B. All their free time', 'C. Only weekends'], correct: 'A' },
          { question: 'When do young people go out with friends?', options: ['A. In the mornings', 'B. In the afternoons', 'C. At night only'], correct: 'B' },
          { question: 'What characterizes modern French lifestyle?', options: ['A. Complete independence', 'B. Only family focus', 'C. Independence and family connection'], correct: 'C' }
        ],
        translations: [
          { es: 'Mi familia es muy unida y nos apoyamos siempre.', fr: 'Ma famille est tr√®s unie et nous nous soutenons toujours.', de: 'Meine Familie ist sehr eng verbunden und wir unterst√ºtzen uns immer.', marks: 2, questionNumber: '40.1' },
          { es: 'Tengo una relaci√≥n muy especial con mis abuelos maternos.', fr: 'J\'ai une relation tr√®s sp√©ciale avec mes grands-parents maternels.', de: 'Ich habe eine sehr besondere Beziehung zu meinen Gro√üeltern m√ºtterlicherseits.', marks: 2, questionNumber: '40.2' },
          { es: 'Los domingos toda la familia se re√∫ne para almorzar juntos.', fr: 'Le dimanche toute la familia se r√©unit pour d√©jeuner ensemble.', de: 'Sonntags versammelt sich die ganze Familie zum gemeinsamen Mittagessen.', marks: 2, questionNumber: '40.3' },
          { es: 'Mis padres me ense√±aron la importancia de los valores familiares.', fr: 'Mes parents m\'ont enseign√© l\'importance des valeurs familiales.', de: 'Meine Eltern haben mir die Wichtigkeit von Familienwerten beigebracht.', marks: 2, questionNumber: '40.4' },
          { es: 'Aunque vivo lejos, mantengo contacto diario con mi hermana.', fr: 'Bien que je vive loin, je maintiens un contact quotidien avec ma s≈ìur.', de: 'Obwohl ich weit weg lebe, halte ich t√§glichen Kontakt mit meiner Schwester.', marks: 2, questionNumber: '40.5' }
        ]
      },
      'Healthy living and lifestyle': { // Existing content, unchanged
        letterMatching: [
          'Pour rester en forme, je fais du sport trois fois par semaine. J\'adore courir au parc.',
          'J\'essaie de manger cinq portions de fruits et l√©gumes par jour. Mon pr√©f√©r√© est la pomme.',
          'Il est important de dormir huit heures chaque nuit pour avoir de l\'√©nergie et √™tre de bonne humeur.',
          'Je bois beaucoup d\'eau pour rester hydrat√©, surtout apr√®s avoir fait de l\'exercice.'
        ],
        options: ['Sports', 'Healthy Eating', 'Sleep', 'Hydration', 'Mindfulness', 'Relaxation'],
        mainText: 'Adopter un mode de vie sain est essentiel pour les jeunes d\'aujourd\'hui. De nombreux adolescents fran√ßais pratiquent des sports comme le football, le basketball ou la natation pour rester actifs. La cuisine fran√ßaise, bien que r√©put√©e pour ses plats riches, int√®gre aussi beaucoup de l√©gumes et de produits frais. Il est crucial d\'√©viter les boissons sucr√©es et la restauration rapide. De plus, le bien-√™tre mental est tout aussi important que la sant√© physique, c\'est pourquoi des activit√©s comme la lecture ou passer du temps avec des amis sont fondamentales pour r√©duire le stress.',
        multipleChoice: [
          { question: 'What is essential for young people today?', options: ['A. Playing video games', 'B. Having a healthy life', 'C. Eating fast food'], correct: 'B' },
          { question: 'Which sports are popular among French teenagers?', options: ['A. Cricket and rugby', 'B. Football, basketball, and swimming', 'C. Golf and tennis'], correct: 'B' },
          { question: 'What is important to avoid for a healthy diet?', options: ['A. Fruits and vegetables', 'B. Sugary drinks and fast food', 'C. Fish and olive oil'], correct: 'B' },
          { question: 'Why are activities like reading or spending time with friends important?', options: ['A. To get good grades', 'B. To reduce stress', 'C. To learn new languages'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'Chlo√©', text: 'Pour avoir une vie √©quilibr√©e, je m\'assure d\'√©tudier et aussi de faire des activit√©s parascolaires. Je joue au handball deux fois par semaine et cela m\'aide √† me d√©tendre. J\'essaie de ne pas passer trop de temps sur les r√©seaux sociaux.' },
          { name: 'Lucas', text: 'Mon d√©fi est de manger plus sainement. J\'adore la restauration rapide, mais je sais que ce n\'est pas bon. Mes parents essaient de nous faire manger plus de l√©gumes √† la maison et j\'apprends √† cuisiner des plats sains.' },
          { name: 'Manon', text: 'Le stress des examens est bien r√©el. Pour le g√©rer, je fais du jogging et j\'√©coute de la musique relaxante. Il est aussi essentiel de parler √† mes amis et √† ma famille si je me sens d√©pass√©e. La sant√© mentale est une priorit√© pour moi.' }
        ],
        gridQuestions: [
          { question: 'Who plays handball to relax?', correct: 'C' },
          { question: 'Who is trying to eat more healthily?', correct: 'L' },
          { question: 'Who likes fast food?', correct: 'L' },
          { question: 'Who manages exam stress with jogging?', correct: 'M' },
          { question: 'Who prioritises mental health?', correct: 'M' },
          { question: 'Who tries to limit time on social media?', correct: 'C' }
        ],
        openResponseText: 'L\'activit√© physique est cruciale pour la sant√©. L\'Organisation Mondiale de la Sant√© recommande que les adolescents fassent au moins 60 minutes d\'activit√© physique mod√©r√©e √† intense chaque jour. Cela peut inclure des sports, de la marche rapide, de la danse ou du v√©lo. Le manque d\'activit√© physique peut entra√Æner des probl√®mes de sant√© comme l\'ob√©sit√© et des maladies cardiovasculaires √† l\'avenir. Il est important de trouver une activit√© que vous aimez pour qu\'il soit plus facile de la maintenir √† long terme.',
        openQuestions: [
          { question: 'How many minutes of physical activity are recommended daily for teenagers?', expectedWords: 2, acceptableAnswers: ['60 minutes', 'sixty minutes', 'at least 60 minutes'] },
          { question: 'Name two activities that count as physical activity.', expectedWords: 4, acceptableAnswers: ['sports and walking', 'dancing and cycling', 'sports dancing', 'walking cycling'] },
          { question: 'What health problem can lack of physical activity lead to?', expectedWords: 1, acceptableAnswers: ['obesity', 'heart disease'] },
          { question: 'Why is it important to find an activity you like?', expectedWords: 5, acceptableAnswers: ['easier to maintain long-term', 'to maintain it longer', 'easier to keep it'] },
          { question: 'What kind of physical activity is recommended?', expectedWords: 4, acceptableAnswers: ['moderate to intense', 'moderate intense'] }
        ],
        timeSequenceText: 'Quand j\'√©tais enfant, je passais des heures √† jouer √† des jeux vid√©o et √† manger beaucoup de sucreries. J\'√©tais assez s√©dentaire. Maintenant, √† l\'adolescence, j\'ai chang√© mes habitudes. Je vais √† la piscine trois fois par semaine et je mange de mani√®re plus √©quilibr√©e. Mes parents m\'ont encourag√© √† √™tre plus actif et m\'ont aid√© √† comprendre l\'importance de la sant√©. L\'ann√©e prochaine, je veux participer √† un marathon. √Ä l\'avenir, j\'esp√®re pouvoir inspirer d\'autres personnes √† adopter un mode de vie sain.',
        timeEvents: [
          { event: 'Spending hours playing video games', correct: 'P' },
          { event: 'Going to the pool three times a week', correct: 'N' },
          { event: 'Planning to participate in a marathon', correct: 'F' },
          { event: 'Being quite sedentary', correct: 'P' },
          { event: 'Hoping to inspire others to adopt a healthy lifestyle', correct: 'F' }
        ],
        headlines: [
          { letter: 'A', text: 'The importance of balanced meals for teenagers' },
          { letter: 'B', text: 'Mental well-being: A priority for young people' },
          { letter: 'C', text: 'How technology influences adolescent sleep patterns' },
          { letter: 'D', text: 'Teenagers opting for outdoor activities over screens' },
          { letter: 'E', text: 'Government campaigns promote healthy habits in schools' },
          { letter: 'F', text: 'The rise of plant-based diets among French youth' }
        ],
        articles: [
          { text: 'Une √©tude r√©cente montre que plus de jeunes Fran√ßais choisissent de passer leur temps libre √† faire de la randonn√©e et du v√©lo plut√¥t que d\'utiliser des appareils √©lectroniques. Cela contribue √† un mode de vie plus actif.', correct: 'D' },
          { text: 'Les nouvelles initiatives gouvernementales visent √† √©duquer les √©tudiants sur l\'importance de la nutrition et de l\'exercice √† travers des ateliers et des programmes sportifs dans les √©coles.', correct: 'E' },
          { text: 'Beaucoup d\'adolescents fran√ßais adoptent des r√©gimes v√©g√©tariens et v√©g√©taliens, ce qui est consid√©r√© comme un pas positif vers une alimentation plus consciente et durable.', correct: 'F' },
          { text: 'Les experts en sant√© mentale soulignent la n√©cessit√© d\'aborder le stress et l\'anxi√©t√© chez les jeunes, en promouvant des activit√©s qui favorisent la relaxation et l\'√©quilibre √©motionnel.', correct: 'B' },
          { text: 'La qualit√© du sommeil chez les adolescents est affect√©e par l\'utilisation excessive de t√©l√©phones portables avant de dormir, ce qui a un impact n√©gatif sur leurs performances scolaires et leur humeur.', correct: 'C' }
        ],
        completionText: 'Une alimentation √©quilibr√©e est fondamentale pour la croissance et le d√©veloppement des adolescents. Inclure une vari√©t√© de fruits, l√©gumes, prot√©ines et c√©r√©ales compl√®tes fournit l\'√©nergie n√©cessaire pour les √©tudes et le sport. √âviter les aliments ultra-transform√©s et les boissons √† forte teneur en sucre est essentiel pour pr√©venir les probl√®mes de sant√© √† long terme comme le diab√®te de type 2. Il est important que les jeunes apprennent √† prendre des d√©cisions saines pour leur bien-√™tre futur.',
        completionSentences: [
          { incomplete: 'A balanced diet is _____ for growth and development.', correct: 'fundamental' },
          { incomplete: 'It provides the necessary _____ for studying and sports.', correct: 'energy' },
          { incomplete: 'Avoiding ultra-processed foods helps _____ long-term health issues.', correct: 'prevent' },
          { incomplete: 'Sugary drinks can lead to problems like Type 2 _____.', correct: 'diabetes' },
          { incomplete: 'Young people should learn to make _____ choices.', correct: 'healthy' }
        ],
        lifestyleText: 'Le mode de vie sain ne concerne pas seulement l\'alimentation et l\'exercice, mais aussi le bien-√™tre mental. En France, les jeunes sont de plus en plus conscients de l\'importance de prendre soin de leur sant√© mentale. Des activit√©s comme la m√©ditation, passer du temps dans la nature ou pratiquer un hobby aident √† r√©duire le stress. C\'est une approche holistique qui combine la bonne alimentation, l\'activit√© physique et la sant√© √©motionnelle pour une vie √©panouie.',
        lifestyleQuestions: [
          { question: 'What does a healthy lifestyle include besides diet and exercise?', options: ['A. Financial stability', 'B. Mental well-being', 'C. Career success'], correct: 'B' },
          { question: 'What are French youth increasingly aware of?', options: ['A. The latest fashion trends', 'B. The importance of mental health', 'C. New technologies'], correct: 'B' },
          { question: 'Name one activity that helps reduce stress.', options: ['A. Playing violent video games', 'B. Meditation', 'C. Eating unhealthy snacks'], correct: 'B' },
          { question: 'What kind of approach is it for a full life?', options: ['A. A physical approach', 'B. A financial approach', 'C. A holistic approach'], correct: 'C' },
          { question: 'How can teenagers find balance between study and leisure?', options: ['A. By only focusing on academics', 'B. By combining both effectively', 'C. By ignoring extracurriculars'], correct: 'B' } // Added question
        ],
        translations: [
          { es: 'Para mantenerme sano, hago deporte regularmente.', fr: 'Pour rester en bonne sant√©, je fais du sport r√©guli√®rement.', de: 'Um gesund zu bleiben, treibe ich regelm√§√üig Sport.', marks: 2, questionNumber: '40.1' },
          { es: 'Comer frutas y verduras es muy importante.', fr: 'Manger des fruits et l√©gumes est tr√®s important.', de: 'Obst und Gem√ºse zu essen ist sehr wichtig.', marks: 2, questionNumber: '40.2' },
          { es: 'Duermo ocho heures chaque nuit pour avoir de l\'√©nergie.', fr: 'Je dors huit heures chaque nuit pour avoir de l\'√©nergie.', de: 'Ich schlafe acht Stunden pro Nacht, um Energie zu haben.', marks: 2, questionNumber: '40.3' },
          { es: 'Evito la restauration rapide et les boissons sucr√©es.', fr: 'J\'√©vite la restauration rapide et les boissons sucr√©es.', de: 'Ich vermeide Fast Food und zuckerhaltige Getr√§nke.', marks: 2, questionNumber: '40.4' },
          { es: 'La sant√© mentale est aussi importante que la sant√© physique.', fr: 'La sant√© mentale est aussi importante que la sant√© physique.', de: 'Mentale Gesundheit ist genauso wichtig wie k√∂rperliche Gesundheit.', marks: 2, questionNumber: '40.5' }
        ]
      },
      'Education and work': { // NEW CONTENT FOR EDUCATION AND WORK
        letterMatching: [
          'Je suis en terminale et je pense aller √† l\'universit√© pour √©tudier le droit.',
          'Ma s≈ìur a√Æn√©e n\'est pas all√©e √† l\'universit√©; elle fait un apprentissage pour √™tre p√¢tissi√®re.',
          'Apr√®s les cours, j\'ai un petit boulot dans un supermarch√© pour gagner un peu d\'argent.',
          'Les examens du baccalaur√©at cette ann√©e sont tr√®s stressants mais importants pour mon avenir.'
        ],
        options: ['University', 'Apprenticeship', 'Part-time job', 'Exams', 'Career choices', 'Studying abroad'],
        mainText: 'En France, l\'enseignement secondaire se termine par le baccalaur√©at, qui est essentiel pour acc√©der √† l\'universit√©. Les √©tudiants peuvent choisir entre des fili√®res g√©n√©rales, technologiques ou professionnelles. De plus en plus de jeunes optent pour l\'alternance, combinant √©tudes et exp√©rience professionnelle en entreprise. La recherche d\'emploi pour les jeunes est un sujet important, et le gouvernement met en place des aides pour faciliter leur insertion professionnelle. Les comp√©tences num√©riques et linguistiques sont tr√®s recherch√©es sur le march√© du travail fran√ßais.',
        multipleChoice: [
          { question: 'What is essential for accessing university in France?', options: ['A. A driver\'s license', 'B. The baccalaur√©at', 'C. A part-time job'], correct: 'B' },
          { question: 'Which types of streams can students choose for secondary education?', options: ['A. Only general', 'B. General, technological, or professional', 'C. Only professional'], correct: 'B' },
          { question: 'What does \'alternance\' combine?', options: ['A. Study and travel', 'B. Study and professional experience', 'C. Study and hobbies'], correct: 'B' },
          { question: 'What is a highly sought-after skill in the French job market?', options: ['A. Cooking skills', 'B. Digital and linguistic skills', 'C. Driving skills'], correct: 'B' },
          { question: 'What is the French government putting in place to help young people find jobs?', options: ['A. New taxes', 'B. Aid to facilitate professional integration', 'C. More exams'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'L√©a', text: 'Je suis en premi√®re ann√©e de fac de m√©decine. C\'est tr√®s exigeant, mais je suis motiv√©e. Je travaille aussi comme b√©n√©vole √† l\'h√¥pital un soir par semaine pour avoir une premi√®re id√©e du m√©tier.' },
          { name: 'Tom', text: 'J\'ai arr√™t√© l\'√©cole apr√®s le brevet. Maintenant je fais un CAP de cuisine en apprentissage. J\'adore cuisiner et j\'esp√®re ouvrir mon propre restaurant un jour.' },
          { name: 'Clara', text: 'Je suis encore au lyc√©e. Je ne sais pas encore si je veux faire des √©tudes longues ou courtes. Mes parents me conseillent de bien r√©fl√©chir √† mes choix d\'orientation.' }
        ],
        gridQuestions: [
          { question: 'Who is volunteering in a hospital?', correct: 'L' },
          { question: 'Who hopes to open their own restaurant?', correct: 'T' },
          { question: 'Who is doing an apprenticeship?', correct: 'T' },
          { question: 'Who is unsure about long or short studies?', correct: 'C' },
          { question: 'Who is studying medicine?', correct: 'L' },
          { question: 'Whose parents advise them on career choices?', correct: 'C' }
        ],
        openResponseText: 'Le taux de ch√¥mage des jeunes en France est une pr√©occupation majeure. Pour y rem√©dier, des initiatives comme le Service Civique ou des contrats aid√©s sont propos√©s. Les entreprises sont encourag√©es √† recruter des jeunes et √† leur offrir des formations. L\'accent est mis sur le d√©veloppement de comp√©tences transversales, comme le travail en √©quipe et la r√©solution de probl√®mes, en plus des comp√©tences techniques. La mobilit√© professionnelle, y compris √† l\'international, est aussi un facteur important pour la r√©ussite des jeunes.',
        openQuestions: [
          { question: 'What is a major concern in France regarding young people?', expectedWords: 4, acceptableAnswers: ['youth unemployment rate', 'the youth unemployment rate', 'unemployment rate of young people'] },
          { question: 'Name one initiative proposed to address youth unemployment.', expectedWords: 3, acceptableAnswers: ['Service Civique', 'aided contracts', 'service civique or aided contracts'] },
          { question: 'What are companies encouraged to do for young people?', expectedWords: 5, acceptableAnswers: ['recruit them and offer training', 'recruit and offer training', 'to recruit them and offer training'] },
          { question: 'Name two transversal skills that are emphasized.', expectedWords: 5, acceptableAnswers: ['teamwork and problem-solving', 'working in a team solving problems', 'problem-solving and teamwork'] },
          { question: 'What is also an important factor for youth success?', expectedWords: 3, acceptableAnswers: ['professional mobility', 'international mobility', 'professional and international mobility'] }
        ],
        timeSequenceText: 'Quand j\'√©tais enfant, je r√™vais de devenir astronaute, m√™me si j\'√©tais nul en sciences. Au coll√®ge, j\'ai d√©couvert ma passion pour l\'informatique. Actuellement, je suis en BTS (Brevet de Technicien Sup√©rieur) en informatique et je fais un stage dans une startup. L\'ann√©e prochaine, j\'aimerais continuer mes √©tudes en licence professionnelle. Dans le futur, j\'esp√®re travailler dans la cybers√©curit√© et contribuer √† prot√©ger les donn√©es importantes.',
        timeEvents: [
          { event: 'Dreaming of becoming an astronaut', correct: 'P' },
          { event: 'Discovering a passion for IT in middle school', correct: 'P' },
          { event: 'Doing an internship in a startup', correct: 'N' },
          { event: 'Planning to continue studies next year', correct: 'F' },
          { event: 'Hoping to work in cybersecurity', correct: 'F' }
        ],
        headlines: [
          { letter: 'A', text: 'New apprenticeship contracts for young people' },
          { letter: 'B', text: 'Digital skills in high demand in the job market' },
          { letter: 'C', text: 'Youth unemployment: Government initiatives' },
          { letter: 'D', text: 'Gap year trend grows among French students' },
          { letter: 'E', text: 'Importance of soft skills for professional integration' },
          { letter: 'F', text: 'Vocational training: A path to quick employment' }
        ],
        articles: [
          { text: 'Le gouvernement annonce de nouveaux dispositifs pour faciliter l\'acc√®s des jeunes √† l\'apprentissage et √† des contrats de professionnalisation.', correct: 'A' },
          { text: 'La capacit√© √† travailler en √©quipe et √† s\'adapter sont d√©sormais aussi importantes que les dipl√¥mes pour trouver un emploi en France.', correct: 'E' },
          { text: 'De plus en plus de lyc√©ens fran√ßais envisagent de prendre une ann√©e sabbatique avant d\'entamer leurs √©tudes sup√©rieures.', correct: 'D' },
          { text: 'Face √† un march√© du travail en √©volution, les comp√©tences num√©riques sont devenues indispensables pour la plupart des postes.', correct: 'B' },
          { text: 'Malgr√© des am√©liorations, la lutte contre le ch√¥mage des jeunes reste une priorit√© pour les pouvoirs publics fran√ßais.', correct: 'C' }
        ],
        completionText: 'L\'orientation professionnelle est une √©tape cl√© pour les jeunes. Choisir la bonne voie n√©cessite de bien se conna√Ætre et de s\'informer sur les diff√©rentes opportunit√©s. Les salons √©tudiants et les conseillers d\'orientation jouent un r√¥le important pour guider les √©l√®ves. Il est √©galement b√©n√©fique de parler avec des professionnels pour comprendre la r√©alit√© des m√©tiers. Un projet professionnel bien d√©fini augmente les chances de r√©ussite dans le parcours √©ducatif et la carri√®re.',
        completionSentences: [
          { incomplete: 'Career guidance is a _____ step for young people.', correct: 'key' },
          { incomplete: 'Choosing the right path requires knowing yourself and getting _____ about opportunities.', correct: 'informed' },
          { incomplete: 'Student fairs and career counselors play an important _____ to guide students.', correct: 'role' },
          { incomplete: 'It is beneficial to talk with _____ to understand the reality of jobs.', correct: 'professionals' },
          { incomplete: 'A well-defined career plan increases chances of _____ in education and career.', correct: 'success' }
        ],
        lifestyleText: 'Le mode de vie sain ne concerne pas seulement l\'alimentation et l\'exercice, mais aussi le bien-√™tre mental. En France, les jeunes sont de plus en plus conscients de l\'importance de prendre soin de leur sant√© mentale. Des activit√©s comme la m√©ditation, passer du temps dans la nature ou pratiquer un hobby aident √† r√©duire le stress. C\'est une approche holistique qui combine la bonne alimentation, l\'activit√© physique et la sant√© √©motionnelle pour une vie √©panouie.',
        lifestyleQuestions: [
          { question: 'What is a key step for young people?', options: ['A. Traveling', 'B. Career guidance', 'C. Learning to drive'], correct: 'B' },
          { question: 'What is important when choosing the right path?', options: ['A. Knowing many people', 'B. Knowing yourself and getting informed', 'C. Having a lot of money'], correct: 'B' },
          { question: 'Who plays an important role in guiding students?', options: ['A. Famous celebrities', 'B. Student fairs and career counselors', 'C. Sports coaches'], correct: 'B' },
          { question: 'What does talking with professionals help to understand?', options: ['A. Their personal lives', 'B. The reality of jobs', 'C. How to make friends'], correct: 'B' },
          { question: 'What increases chances of success in education and career?', options: ['A. A rich family', 'B. A well-defined career plan', 'C. Only good luck'], correct: 'B' }
        ],
        translations: [
          { es: 'J\'√©tudie pour le baccalaur√©at cette ann√©e.', fr: 'J\'√©tudie pour le baccalaur√©at cette ann√©e.', de: 'Ich lerne dieses Jahr f√ºr das Abitur.', marks: 2, questionNumber: '41.1' },
          { es: 'Je voudrais faire un stage dans une entreprise.', fr: 'Je voudrais faire un stage dans une entreprise.', de: 'Ich m√∂chte ein Praktikum in einer Firma machen.', marks: 2, questionNumber: '41.2' },
          { es: 'Le travail √† temps partiel m\'aide √† √™tre ind√©pendant.', fr: 'Le travail √† temps partiel m\'aide √† √™tre ind√©pendant.', de: 'Mein Teilzeitjob hilft mir, unabh√§ngig zu sein.', marks: 2, questionNumber: '41.3' },
          { es: 'Les langues √©trang√®res sont utiles pour ma future profession.', fr: 'Les langues √©trang√®res sont utiles pour ma future profession.', de: 'Fremdsprachen sind n√ºtzlich f√ºr meinen zuk√ºnftigen Beruf.', marks: 2, questionNumber: '41.4' },
          { es: 'Le ch√¥mage des jeunes est un grand d√©fi.', fr: 'Le ch√¥mage des jeunes est un grand d√©fi.', de: 'Jugendarbeitslosigkeit ist eine gro√üe Herausforderung.', marks: 2, questionNumber: '41.5' }
        ]
      }
    }
  };

  const themeData = variations[theme];
  if (!themeData) {
    console.warn(`No specific variations found for theme: ${theme} - using default French.`);
    return getDefaultFrenchVariations();
  }
  const topicData = themeData[topic];
  if (!topicData) {
    console.warn(`No specific variations found for topic: ${topic} under theme ${theme} - using default French.`);
    return getDefaultFrenchVariations();
  }
  return topicData;
}

// --- Default French Content for Fallback ---
function getDefaultFrenchVariations() {
  return {
    letterMatching: [
      'J\'aime faire des activit√©s diff√©rentes pendant mon temps libre.',
      'Je pratique des sports avec mes amis les week-ends.',
      'Je lis des livres int√©ressants √† la biblioth√®que municipale.',
      'J\'√©coute de la musique en faisant mes devoirs.'
    ],
    options: ['Sports', 'Reading', 'Music', 'Art', 'Gaming', 'Cooking'],
    mainText: 'Ceci est un texte d\'exemple pour les √©valuations th√©matiques.',
    multipleChoice: [
      { question: 'Question d\'exemple?', options: ['A. Option 1', 'B. Option 2', 'C. Option 3'], correct: 'A' }
    ],
    studentGrid: [
      { name: '√âtudiant1', text: 'Texte d\'exemple 1' },
      { name: '√âtudiant2', text: 'Texte d\'exemple 2' },
      { name: '√âtudiant3', text: 'Texte d\'exemple 3' }
    ],
    gridQuestions: [
      { question: 'Question d\'exemple?', correct: 'A' }
    ],
    openResponseText: 'Texte de r√©ponse ouverte d\'exemple.',
    openQuestions: [
      { question: 'Question d\'exemple?', expectedWords: 2, acceptableAnswers: ['r√©ponse exemple'] }
    ],
    timeSequenceText: 'Texte de s√©quence temporelle d\'exemple.',
    timeEvents: [
      { event: '√âv√©nement d\'exemple', correct: 'P' }
    ],
    headlines: [
      { letter: 'A', text: 'Titre d\'exemple' }
    ],
    articles: [
      { text: 'Texte d\'article d\'exemple.', correct: 'A' }
    ],
    completionText: 'Texte de compl√©tion d\'exemple.',
    completionSentences: [
      { incomplete: 'Phrase _____ d\'exemple.', correct: 'compl√®te' }
    ],
    lifestyleText: 'Texte de style de vie d\'exemple.',
    lifestyleQuestions: [
      { question: 'Question d\'exemple?', options: ['A. Option 1', 'B. Option 2', 'C. Option 3'], correct: 'A' }
    ],
    translations: [
      { es: 'Ejemplo de traducci√≥n.', fr: 'Exemple de traducci√≥n.', de: 'Beispiel f√ºr √úbersetzung.', marks: 2, questionNumber: '40.1' }
    ]
  };
}

/**
 * Generates French topic questions for a specific topic - ALL 40 QUESTIONS
 * @param {string} theme - The AQA theme ID.
 * @param {string} topic - The AQA topic name.
 * @param {string} assessmentId - The ID of the assessment this question belongs to.
 * @param {'foundation' | 'higher'} level - The difficulty level ('foundation' or 'higher').
 * @returns {Array<AQATopicQuestionDefinition>} An array of question objects.
 */
function generateFrenchTopicQuestions(theme: string, topic: string, assessmentId: string, level: 'foundation' | 'higher'): AQATopicQuestionDefinition[] {
  // Topic-specific content variations
  const topicVariations = getFrenchTopicVariations(theme, topic);

  return [
    // Questions 1-4: Letter Matching - Topic-focused activities (4 marks)
    {
      question_number: 1,
      question_type: 'letter-matching',
      title: `Questions 1-4: ${topic} - Activities and interests`,
      instructions: `Some French teenagers are talking about activities related to ${topic.toLowerCase()}. Which activity does each person mention? Write the correct letter in each box.`,
      marks: 4,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        students: [
          { name: 'Am√©lie', text: topicVariations.letterMatching[0] },
          { name: 'Pierre', text: topicVariations.letterMatching[1] },
          { name: 'Camille', text: topicVariations.letterMatching[2] },
          { name: 'Julien', text: topicVariations.letterMatching[3] }
        ],
        options: [
          { letter: 'A', subject: topicVariations.options[0] }, // Matches letterMatching[0]
          { letter: 'B', subject: topicVariations.options[1] }, // Matches letterMatching[1]
          { letter: 'C', subject: topicVariations.options[2] }, // Matches letterMatching[2]
          { letter: 'D', subject: topicVariations.options[3] }, // Matches letterMatching[3]
          { letter: 'E', subject: topicVariations.options[4] },
          { letter: 'F', subject: topicVariations.options[5] }
        ],
        // Shuffled answers
        correctAnswers: { 'Am√©lie': 'A', 'Pierre': 'D', 'Camille': 'B', 'Julien': 'C' }
      }
    },

    // Questions 5-9: Multiple Choice - Topic-focused reading (5 marks)
    {
      question_number: 5,
      question_type: 'multiple-choice',
      title: `Questions 5-9: ${topic}`,
      instructions: `You read this extract about ${topic.toLowerCase()}. Answer the questions by selecting the correct option.`,
      reading_text: topicVariations.mainText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.multipleChoice
      }
    },

    // Questions 10-15: Student Grid - Topic-focused activities (6 marks)
    {
      question_number: 10,
      question_type: 'student-grid',
      title: `Questions 10-15: ${topic} - Student experiences`,
      instructions: `You see an online forum. Some French students are discussing ${topic.toLowerCase()}. Answer the following questions. Write C for Chlo√©, L for Lucas, M for Manon.`, // Updated names
      marks: 6,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        students: ['C', 'L', 'M'], // Updated names
        studentTexts: topicVariations.studentGrid,
        questions: topicVariations.gridQuestions
      }
    },

    // Questions 16-20: Open Response - Topic-focused article (5 marks)
    {
      question_number: 16,
      question_type: 'open-response',
      title: `Questions 16-20: ${topic} in France`,
      instructions: `You read this extract from an article about ${topic.toLowerCase()} in France. Answer the following questions in English.`,
      reading_text: topicVariations.openResponseText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.openQuestions
      }
    },

    // Questions 21-25: Time Sequence - Topic-focused interview (5 marks)
    {
      question_number: 21,
      question_type: 'time-sequence',
      title: `Questions 21-25: Interview about ${topic}`,
      instructions: `A French person talks about their experience with ${topic.toLowerCase()}. When do these events happen according to the article? Write P for something that happened in the past, N for something that is happening now, F for something that is going to happen in the future.`,
      reading_text: topicVariations.timeSequenceText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        events: topicVariations.timeEvents
      }
    },

    // Questions 26-30: Headline Matching - Topic-focused news (5 marks)
    {
      question_number: 26,
      question_type: 'headline-matching',
      title: `Questions 26-30: News headlines about ${topic}`,
      instructions: `Match each news article extract with the correct headline. Write the correct letter in each box.`,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        headlines: topicVariations.headlines,
        articles: topicVariations.articles
      }
    },

    // Questions 31-35: Sentence Completion - Topic-focused article (5 marks)
    {
      question_number: 31,
      question_type: 'sentence-completion',
      title: `Questions 31-35: ${topic}`,
      instructions: `Complete the sentences based on the text. Write the missing words in English.`,
      reading_text: topicVariations.completionText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        sentences: topicVariations.completionSentences
      }
    },

    // Questions 36-40: Multiple Choice - Topic-focused lifestyle (5 marks)
    {
      question_number: 36,
      question_type: 'multiple-choice',
      title: `Questions 36-40: ${topic} and lifestyle`,
      instructions: `Read this article about ${topic.toLowerCase()}. Answer the questions by selecting the correct option.`,
      reading_text: topicVariations.lifestyleText,
      marks: 5, // Changed from 4 to 5 marks
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.lifestyleQuestions
      }
    },

    // Question 41: Translation - Topic-focused sentences (10 marks)
    {
      question_number: 41, // Changed from 40 to 41
      question_type: 'translation',
      title: `Question 41: Translation about ${topic}`, // Changed from 40 to 41
      instructions: `Translate these sentences about ${topic.toLowerCase()} into English.`,
      marks: 10,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        // Updated to use spread operator
        sentences: topicVariations.translations.map((t: any, i: number) => ({
          ...t, // This ensures all language properties (es, fr, de) are included
          questionNumber: `41.${i + 1}` // Changed from 40 to 41
        }))
      }
    }
  ];
}

// --- Specific Content Variations for German ---
function getGermanTopicVariations(theme: string, topic: string) {
  const variations: Record<string, Record<string, any>> = {
    'Theme 1: People and lifestyle': {
      'Identity and relationships with others': { // Existing content, unchanged
        letterMatching: [
          'Ich verbringe gerne Zeit mit meiner Familie. Wir organisieren immer Familientreffen am Sonntag.',
          'Ich habe viele Freunde aus verschiedenen L√§ndern. Ich lerne gerne √ºber ihre Kulturen und Traditionen.',
          'Meine kleine Schwester und ich teilen viele Geheimnisse. Sie ist meine beste Vertraute.',
          'Meine Gro√üeltern wohnen in unserer N√§he. Wir besuchen sie jede Woche zum gemeinsamen Mittagessen.'
        ],
        options: ['Family time', 'Cultural exchange', 'Sibling bonds', 'Grandparent visits', 'Friendship', 'Community'],
        mainText: 'Familienbeziehungen sind grundlegend in der deutschen Kultur. In meiner Familie haben wir sehr wichtige Traditionen wie das Sonntagsessen, bei dem sich die ganze Familie versammelt. Meine Gro√ümutter bereitet immer Sauerbraten zu und meine Cousins kommen aus M√ºnchen, um bei uns zu sein. W√§hrend dieser Treffen sprechen wir √ºber unser Leben, teilen Neuigkeiten und st√§rken unsere Familienbande. Deutsche Jugendliche sch√§tzen diese Traditionen sehr, weil sie uns helfen, unsere kulturelle Identit√§t zu bewahren.',
        multipleChoice: [
          { question: 'What is fundamental in German culture?', options: ['A. Work relationships', 'B. Family relationships', 'C. School relationships'], correct: 'B' },
          { question: 'When does the family meet?', options: ['A. Sunday meals', 'B. Saturday evenings', 'C. Friday afternoons'], correct: 'A' },
          { question: 'What does the grandmother prepare?', options: ['A. Schnitzel', 'B. Sauerbraten', 'C. Bratwurst'], correct: 'B' },
          { question: 'Where do the cousins come from?', options: ['A. Berlin', 'B. M√ºnchen', 'C. Hamburg'], correct: 'B' },
          { question: 'Why do German youth value these traditions?', options: ['A. They are fun', 'B. They maintain cultural identity', 'C. They are required'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'Lukas', text: 'In meiner Familie sind wir sehr eng verbunden. Ich habe drei Br√ºder und wir unterst√ºtzen uns immer gegenseitig. Wenn ich Probleme habe, spreche ich mit meinem √§lteren Bruder, weil er mir gute Ratschl√§ge gibt. Am Wochenende machen wir Aktivit√§ten zusammen wie ins Kino gehen oder Fu√üball im Park spielen.' },
          { name: 'Sarah', text: 'Meine Eltern haben sich scheiden lassen, als ich klein war, aber wir haben eine gute Beziehung. Ich lebe unter der Woche bei meiner Mutter und am Wochenende bei meinem Vater. Am Anfang war es schwierig, aber jetzt bin ich daran gew√∂hnt. Das Wichtige ist, dass beide mich sehr lieben.' },
          { name: 'Moritz', text: 'Ich bin Einzelkind, aber ich f√ºhle mich nicht einsam, weil ich viele Cousins habe. Meine Onkel und Tanten leben in derselben Stadt und wir sehen uns h√§ufig. W√§hrend der Sommerferien fahren wir alle zusammen an die Ostsee. Es ist wie Geschwister zu haben.' }
        ],
        gridQuestions: [
          { question: 'Who has three brothers?', correct: 'L' },
          { question: 'Who talks to their older brother for advice?', correct: 'L' },
          { question: 'Whose parents are divorced?', correct: 'S' },
          { question: 'Who is an only child?', correct: 'M' },
          { question: 'Who has many cousins?', correct: 'M' },
          { question: 'Who goes to the Baltic Sea during summer holidays?', correct: 'M' }
        ],
        openResponseText: 'Die Familienstruktur in Deutschland hat sich in den letzten Jahrzehnten stark ver√§ndert. Traditionell waren deutsche Familien ziemlich gro√ü, mit mehreren Kindern und manchmal mehreren Generationen, die im selben Haus lebten. Heute sind Familien kleiner, mit h√∂chstens ein oder zwei Kindern. Viele junge Menschen leben bis zum Alter von achtundzwanzig Jahren bei ihren Eltern aufgrund der wirtschaftlichen Situation. Dennoch bleiben die Familienbande sehr stark und Familientreffen sind weiterhin wichtig in der deutschen Kultur.',
        openQuestions: [
          { question: 'How has the German family structure changed?', expectedWords: 3, acceptableAnswers: ['families are smaller', 'fewer children now', 'smaller families today'] },
          { question: 'How many children do families have today?', expectedWords: 3, acceptableAnswers: ['one or two', 'maximum two children', 'one two maximum'] },
          { question: 'Until what age do young people live with parents?', expectedWords: 3, acceptableAnswers: ['twenty-eight years', 'age twenty-eight', 'until 28'] },
          { question: 'Why do young people stay with parents longer?', expectedWords: 3, acceptableAnswers: ['economic situation', 'financial reasons', 'economic problems'] },
          { question: 'What remains important in German culture?', expectedWords: 3, acceptableAnswers: ['family meetings', 'family reunions', 'family gatherings'] }
        ],
        timeSequenceText: 'Als ich Kind war, lebte ich bei meinen Gro√üeltern in einem kleinen Dorf in Bayern. Jetzt lebe ich in Berlin bei meinen Eltern und studiere an der Universit√§t. Meine Beziehung zu meiner Familie hat sich seitdem sehr ver√§ndert. Fr√ºher war ich v√∂llig abh√§ngig von meinen Gro√üeltern f√ºr alles. Derzeit bin ich unabh√§ngiger, aber ich sch√§tze immer noch die Zeit, die ich mit meiner Familie verbringe. N√§chstes Jahr plane ich, in meine eigene Wohnung zu ziehen, aber ich m√∂chte h√§ufigen Kontakt mit allen halten. In der Zukunft, wenn ich meine eigene Familie habe, hoffe ich, die gleichen Werte zu vermitteln, die ich von meinen Gro√üeltern gelernt habe.',
        timeEvents: [
          { event: 'Living in Berlin and studying', correct: 'N' },
          { event: 'Living with grandparents in Bavaria', correct: 'P' },
          { event: 'Being completely dependent on grandparents', correct: 'P' },
          { event: 'Planning to move to own apartment', correct: 'F' },
          { event: 'Having own family and transmitting values', correct: 'F' }
        ],
        headlines: [
          { letter: 'A', text: 'German families celebrate traditional Sunday meals' },
          { letter: 'B', text: 'Young adults living with parents longer due to economy' },
          { letter: 'C', text: 'Grandparents play important role in childcare' },
          { letter: 'D', text: 'Divorce rates increase but family bonds remain strong' },
          { letter: 'E', text: 'German youth value cultural identity through family' },
          { letter: 'F', text: 'Multi-generational homes becoming less common' }
        ],
        articles: [
          { text: 'Deutsche Jugendliche bleiben l√§nger bei ihren Eltern aufgrund der Wirtschaftskrise und des Mangels an stabilen Arbeitspl√§tzen.', correct: 'B' },
          { text: 'Deutsche Familien halten an der Tradition der Sonntagsessen fest, um Familienbande zu st√§rken und kulturelle Werte zu vermitteln.', correct: 'A' },
          { text: 'Obwohl die Scheidungsraten in Deutschland gestiegen sind, bleiben die Familienbande stark und Familien finden neue Wege, zusammenzubleiben.', correct: 'D' },
          { text: 'Deutsche Gro√üeltern spielen eine entscheidende Rolle bei der Kinderbetreuung, besonders wenn beide Eltern au√üer Haus arbeiten.', correct: 'C' },
          { text: 'Deutsche Jugendliche betrachten die Aufrechterhaltung von Familientraditionen als wesentlich f√ºr die Bewahrung ihrer kulturellen Identit√§t in einem globalisierten Welt.', correct: 'E' }
        ],
        completionText: 'Die pers√∂nliche Identit√§t bildet sich durch die Beziehungen, die wir zu anderen aufbauen. In Deutschland spielt die erweiterte Familie eine grundlegende Rolle in der Entwicklung der Pers√∂nlichkeit junger Menschen. Gro√üeltern √ºbertragen Geschichten und Traditionen, Eltern bieten emotionale und wirtschaftliche Unterst√ºtzung, und Geschwister bieten Gesellschaft und Verst√§ndnis. Diese vielf√§ltigen Beziehungen helfen dabei, eine solide Identit√§t und ein Gef√ºhl der Zugeh√∂rigkeit zur Gemeinschaft zu schaffen.',
        completionSentences: [
          { incomplete: 'Personal identity is formed through _____ with others.', correct: 'relationships' },
          { incomplete: 'Extended family plays a _____ role in development.', correct: 'fundamental' },
          { incomplete: 'Grandparents transmit _____ and traditions.', correct: 'stories' },
          { incomplete: 'Parents provide emotional and _____ support.', correct: 'economic' },
          { incomplete: 'These relationships help create a sense of _____.', correct: 'belonging' }
        ],
        lifestyleText: 'Das Gleichgewicht zwischen Familien- und Privatleben ist f√ºr Deutsche sehr wichtig. Viele Menschen widmen jede Woche spezielle Zeit der Familie, behalten aber auch ihre eigenen Hobbys und Interessen bei. Es ist √ºblich, dass junge Leute nachmittags mit Freunden ausgehen, aber zum Abendessen mit der Familie nach Hause kommen. Diese Kombination aus Unabh√§ngigkeit und famili√§rer Verbindung charakterisiert den modernen deutschen Lebensstil.',
        lifestyleQuestions: [
          { question: 'What is important for Germans?', options: ['A. Work-life balance', 'B. Family-personal life balance', 'C. Study-leisure balance'], correct: 'B' },
          { question: 'How much time do people dedicate to family?', options: ['A. Specific time each week', 'B. All their free time', 'C. Only weekends'], correct: 'A' },
          { question: 'When do young people go out with friends?', options: ['A. In the mornings', 'B. In the afternoons', 'C. At night only'], correct: 'B' },
          { question: 'What characterizes modern German lifestyle?', options: ['A. Complete independence', 'B. Only family focus', 'C. Independence and family connection'], correct: 'C' }
        ],
        translations: [
          { es: 'Mi familia es muy unida y nos apoyamos siempre.', fr: 'Ma famille est tr√®s unie et nous nous soutenons toujours.', de: 'Meine Familie ist sehr eng verbunden und wir unterst√ºtzen uns immer.', marks: 2, questionNumber: '40.1' },
          { es: 'Tengo una relaci√≥n muy especial con mis abuelos maternos.', fr: 'J\'ai une relation tr√®s sp√©ciale avec mes grands-parents maternels.', de: 'Ich habe eine sehr besondere Beziehung zu meinen Gro√üeltern m√ºtterlicherseits.', marks: 2, questionNumber: '40.2' },
          { es: 'Los domingos toda la familia se re√∫ne para almorzar juntos.', fr: 'Le dimanche toute la familia se r√©unit pour d√©jeuner ensemble.', de: 'Sonntags versammelt sich die ganze Familie zum gemeinsamen Mittagessen.', marks: 2, questionNumber: '40.3' },
          { es: 'Mis padres me ense√±aron la importancia de los valores familiares.', fr: 'Mes parents m\'ont enseign√© l\'importance des valeurs familiales.', de: 'Meine Eltern haben mir die Wichtigkeit von Familienwerten beigebracht.', marks: 2, questionNumber: '40.4' },
          { es: 'Aunque vivo lejos, mantengo contacto diario con mi hermana.', fr: 'Bien que je vive loin, je maintiens un contact quotidien avec ma s≈ìur.', de: 'Obwohl ich weit weg lebe, halte ich t√§glichen Kontakt mit meiner Schwester.', marks: 2, questionNumber: '40.5' }
        ]
      },
      'Healthy living and lifestyle': { // Existing content, unchanged
        letterMatching: [
          'Um fit zu bleiben, mache ich dreimal pro Woche Sport. Ich liebe es, im Park zu joggen.',
          'Ich versuche, f√ºnf Portionen Obst und Gem√ºse pro Tag zu essen. Mein Lieblingsgem√ºse ist Karotte.',
          'Es ist wichtig, acht Stunden pro Nacht zu schlafen, um Energie und gute Laune zu haben.',
          'Ich trinke viel Wasser, um hydriert zu bleiben, besonders nach dem Sport.'
        ],
        options: ['Sports', 'Healthy Eating', 'Sleep', 'Hydration', 'Mindfulness', 'Relaxation'],
        mainText: 'Ein gesunder Lebensstil ist f√ºr die Jugendlichen von heute unerl√§sslich. Viele deutsche Teenager treiben Sport wie Fu√üball, Handball oder Schwimmen, um aktiv zu bleiben. Die deutsche K√ºche, obwohl oft mit deftigen Gerichten assoziiert, bietet auch viele gesunde Optionen mit viel Gem√ºse und frischen Produkten. Es ist entscheidend, zuckerhaltige Getr√§nke und Fast Food zu vermeiden. Dar√ºber hinaus ist mentales Wohlbefinden genauso wichtig wie k√∂rperliche Gesundheit, weshalb Aktivit√§ten wie Lesen oder Zeit mit Freunden verbringen entscheidend sind, um Stress abzubauen.',
        multipleChoice: [
          { question: 'What is essential for young people today?', options: ['A. Playing video games', 'B. Having a healthy life', 'C. Eating fast food'], correct: 'B' },
          { question: 'Which sports are popular among German teenagers?', options: ['A. Cricket and rugby', 'B. Football, handball, and swimming', 'C. Golf and tennis'], correct: 'B' },
          { question: 'What is important to avoid for a healthy diet?', options: ['A. Fruits and vegetables', 'B. Sugary drinks and fast food', 'C. Fish and olive oil'], correct: 'B' },
          { question: 'Why are activities like reading or spending time with friends important?', options: ['A. To get good grades', 'B. To reduce stress', 'C. To learn new languages'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'Finn', text: 'Um ein ausgewogenes Leben zu f√ºhren, achte ich darauf, zu lernen und auch au√üerschulische Aktivit√§ten zu machen. Ich spiele Volleyball zweimal pro Woche und das hilft mir, mich zu entspannen. Ich versuche, nicht zu viel Zeit in sozialen Medien zu verbringen.' },
          { name: 'Lena', text: 'Meine Herausforderung ist es, ges√ºnder zu essen. Ich liebe Fast Food, aber ich wei√ü, dass es nicht gut ist. Meine Eltern versuchen, dass wir zu Hause mehr Gem√ºse essen, und ich lerne, gesunde Gerichte zu kochen.' },
          { name: 'Julian', text: 'Der Pr√ºfungsstress ist real. Um damit umzugehen, mache ich Achtsamkeits√ºbungen und h√∂re entspannende Musik. Es ist auch wichtig, mit meinen Freunden und meiner Familie zu sprechen, wenn ich mich √ºberfordert f√ºhle. Mentale Gesundheit ist f√ºr mich eine Priorit√§t.' }
        ],
        gridQuestions: [
          { question: 'Who plays volleyball to relax?', correct: 'F' },
          { question: 'Who is trying to eat more healthily?', correct: 'L' },
          { question: 'Who likes fast food?', correct: 'L' },
          { question: 'Who manages exam stress with mindfulness exercises?', correct: 'J' },
          { question: 'Who prioritises mental health?', correct: 'J' },
          { question: 'Who tries to limit time on social media?', correct: 'F' }
        ],
        openResponseText: 'K√∂rperliche Aktivit√§t ist entscheidend f√ºr die Gesundheit. Die Weltgesundheitsorganisation empfiehlt, dass Jugendliche t√§glich mindestens 60 Minuten moderate bis intensive k√∂rperliche Aktivit√§t aus√ºben. Dies kann Sport, schnelles Gehen, Tanzen oder Radfahren umfassen. Mangelnde k√∂rperliche Aktivit√§t kann zuk√ºnftig zu Gesundheitsproblemen wie Fettleibigkeit und Herz-Kreislauf-Erkrankungen f√ºhren. Es ist wichtig, eine Aktivit√§t zu finden, die Ihnen Spa√ü macht, damit es einfacher ist, sie langfristig beizubehalten.',
        openQuestions: [
          { question: 'How many minutes of physical activity are recommended daily for teenagers?', expectedWords: 2, acceptableAnswers: ['60 minutes', 'sixty minutes', 'at least 60 minutes'] },
          { question: 'Name two activities that count as physical activity.', expectedWords: 4, acceptableAnswers: ['sports and walking', 'dancing and cycling', 'sports dancing', 'walking cycling'] },
          { question: 'What health problem can lack of physical activity lead to?', expectedWords: 1, acceptableAnswers: ['obesity', 'heart disease'] },
          { question: 'Why is it important to find an activity you like?', expectedWords: 5, acceptableAnswers: ['easier to maintain long-term', 'to maintain it longer', 'easier to keep it'] },
          { question: 'What kind of physical activity is recommended?', expectedWords: 4, acceptableAnswers: ['moderate to intense', 'moderate intense'] }
        ],
        timeSequenceText: 'Als ich Kind war, verbrachte ich Stunden mit Videospielen und a√ü viele S√º√üigkeiten. Ich war ziemlich sesshaft. Jetzt, in der Jugend, habe ich meine Gewohnheiten ge√§ndert. Ich gehe dreimal pro Woche ins Schwimmbad und ern√§hre mich ausgewogener. Meine Eltern ermutigten mich, aktiver zu sein, und halfen mir, die Bedeutung von Gesundheit zu verstehen. N√§chstes Jahr m√∂chte ich an einem 10-km-Lauf teilnehmen. In Zukunft hoffe ich, andere dazu inspirieren zu k√∂nnen, einen gesunden Lebensstil anzunehmen.',
        timeEvents: [
          { event: 'Spending hours playing video games', correct: 'P' },
          { event: 'Going to the swimming pool three times to week', correct: 'N' },
          { event: 'Planning to participate in a 10km run', correct: 'F' },
          { event: 'Being quite sedentary', correct: 'P' },
          { event: 'Hoping to inspire others to adopt a healthy lifestyle', correct: 'F' }
        ],
        headlines: [
          { letter: 'A', text: 'The importance of balanced meals for teenagers' },
          { letter: 'B', text: 'Mental well-being: A priority for young people' },
          { letter: 'C', text: 'How technology influences adolescent sleep patterns' },
          { letter: 'D', text: 'Teenagers opting for outdoor activities over screens' },
          { letter: 'E', text: 'Government campaigns promote healthy habits in schools' },
          { letter: 'F', text: 'The rise of plant-based diets among German youth' }
        ],
        articles: [
          { text: 'Eine neue Studie zeigt, dass mehr deutsche Jugendliche ihre Freizeit lieber mit Wandern und Radfahren verbringen, anstatt elektronische Ger√§te zu nutzen. Dies tr√§gt zu einem aktiveren Lebensstil bei.', correct: 'D' },
          { text: 'Neue staatliche Initiativen zielen darauf ab, Sch√ºler durch Workshops und Sportprogramme in Schulen √ºber die Bedeutung von Ern√§hrung und Bewegung aufzukl√§ren.', correct: 'E' },
          { text: 'Viele deutsche Jugendliche nehmen vegetarische und vegane Ern√§hrungsweisen an, was als positiver Schritt zu einer bewussteren und nachhaltigeren Ern√§hrung angesehen wird.', correct: 'F' },
          { text: 'Mentalexperten betonen die Notwendigkeit, Stress und Angst bei Jugendlichen anzugehen, indem sie Aktivit√§ten f√∂rdern, die Entspannung und emotionales Gleichgewicht unterst√ºtzen.', correct: 'B' },
          { text: 'Die Schlafqualit√§t bei Jugendlichen wird durch √ºberm√§√üigen Gebrauch von Mobiltelefonen vor dem Schlafengehen beeintr√§chtigt, was sich negativ auf ihre schulischen Leistungen und ihre Stimmung auswirkt.', correct: 'C' }
        ],
        completionText: 'Eine ausgewogene Ern√§hrung ist f√ºr das Wachstum und die Entwicklung von Jugendlichen unerl√§sslich. Eine Vielfalt an Obst, Gem√ºse, Proteinen und Vollkornprodukten liefert die n√∂tige Energie f√ºr das Lernen und den Sport. Das Vermeiden von ultra-verarbeiteten Lebensmitteln und zuckerhaltigen Getr√§nken ist entscheidend, um langfristige Gesundheitsprobleme wie Typ-2-Diabetes zu verhindern. Es ist wichtig, dass junge Menschen lernen, gesunde Entscheidungen f√ºr ihr zuk√ºnftiges Wohlbefinden zu treffen.',
        completionSentences: [
          { incomplete: 'A balanced diet is _____ for growth and development.', correct: 'fundamental' },
          { incomplete: 'It provides the necessary _____ for studying and sports.', correct: 'energy' },
          { incomplete: 'Avoiding ultra-processed foods helps _____ long-term health issues.', correct: 'prevent' },
          { incomplete: 'Sugary drinks can lead to problems like Type 2 _____.', correct: 'diabetes' },
          { incomplete: 'Young people should learn to make _____ choices.', correct: 'healthy' }
        ],
        lifestyleText: 'Ein gesunder Lebensstil umfasst nicht nur Ern√§hrung und Bewegung, sondern auch das mentale Wohlbefinden. In Deutschland sind sich junge Menschen zunehmend der Bedeutung bewusst, auf ihre mentale Gesundheit zu achten. Aktivit√§ten wie Meditation, Zeit in der Natur verbringen oder ein Hobby aus√ºben helfen, Stress abzubauen. Es ist ein ganzheitlicher Ansatz, der gute Ern√§hrung, k√∂rperliche Aktivit√§t und emotionale Gesundheit f√ºr ein erf√ºlltes Leben kombiniert.',
        lifestyleQuestions: [
          { question: 'What does a healthy lifestyle include besides diet and exercise?', options: ['A. Financial stability', 'B. Mental well-being', 'C. Career success'], correct: 'B' },
          { question: 'What are German youth increasingly aware of?', options: ['A. The latest fashion trends', 'B. The importance of mental health', 'C. New technologies'], correct: 'B' },
          { question: 'Name one activity that helps reduce stress.', options: ['A. Playing violent video games', 'B. Meditation', 'C. Eating unhealthy snacks'], correct: 'B' },
          { question: 'What kind of approach is it for a full life?', options: ['A. A physical approach', 'B. A financial approach', 'C. A holistic approach'], correct: 'C' },
          { question: 'How can teenagers find balance between study and leisure?', options: ['A. By only focusing on academics', 'B. By combining both effectively', 'C. By ignoring extracurriculars'], correct: 'B' } // Added question
        ],
        translations: [
          { es: 'Para mantenerme sano, hago deporte regularmente.', fr: 'Pour rester en bonne sant√©, je fais du sport r√©guli√®rement.', de: 'Um gesund zu bleiben, treibe ich regelm√§√üig Sport.', marks: 2, questionNumber: '40.1' },
          { es: 'Comer frutas y verduras es muy importante.', fr: 'Manger des fruits et l√©gumes est tr√®s important.', de: 'Obst und Gem√ºse zu essen ist sehr wichtig.', marks: 2, questionNumber: '40.2' },
          { es: 'Duermo ocho Stunden pro Nacht, um Energie zu haben.', fr: 'Je dors huit heures chaque nuit pour avoir de l\'√©nergie.', de: 'Ich schlafe acht Stunden pro Nacht, um Energie zu haben.', marks: 2, questionNumber: '40.3' },
          { es: 'Evito la comida r√°pida y zuckerhaltige Getr√§nke.', fr: 'J\'√©vite la restauration rapide et les boissons sucr√©es.', de: 'Ich vermeide Fast Food und zuckerhaltige Getr√§nke.', marks: 2, questionNumber: '40.4' },
          { es: 'La salud mental es tan importante como la f√≠sica.', fr: 'La salud mental ist genauso wichtig wie die k√∂rperliche Gesundheit.', de: 'Mentale Gesundheit ist genauso wichtig wie k√∂rperliche Gesundheit.', marks: 2, questionNumber: '40.5' }
        ]
      },
      'Education and work': { // NEW CONTENT FOR EDUCATION AND WORK
        letterMatching: [
          'Ich bin im letzten Schuljahr und √ºberlege, an die Universit√§t zu gehen, um Medizin zu studieren.',
          'Mein √§lterer Bruder hat sich gegen die Uni entschieden; er macht eine Ausbildung zum Kfz-Mechatroniker.',
          'Nach der Schule habe ich einen Nebenjob in einem Caf√©, um mir etwas dazuzuverdienen.',
          'Die Abiturpr√ºfungen dieses Jahr sind entscheidend f√ºr meinen weiteren Bildungsweg.'
        ],
        options: ['University', 'Apprenticeship', 'Part-time job', 'Exams', 'Career choices', 'Studying abroad'],
        mainText: 'In Deutschland endet die Schulpflicht nach neun oder zehn Jahren. Danach k√∂nnen Sch√ºler entweder das Gymnasium besuchen, um das Abitur zu machen und an die Universit√§t zu gehen, oder eine berufliche Ausbildung beginnen. Viele Jugendliche kombinieren auch Schule oder Studium mit Nebenjobs, um praktische Erfahrungen zu sammeln. Die Wahl des richtigen Berufes ist eine wichtige Entscheidung, die oft von pers√∂nlichen Interessen und dem Arbeitsmarkt beeinflusst wird. Digitale Kompetenzen und Fremdsprachenkenntnisse sind auf dem deutschen Arbeitsmarkt sehr gefragt.',
        multipleChoice: [
          { question: 'When does compulsory schooling end in Germany?', options: ['A. After 7 years', 'B. After 9 or 10 years', 'C. After 12 years'], correct: 'B' },
          { question: 'What does Gymnasium prepare students for?', options: ['A. A specific trade', 'B. University', 'C. A part-time job'], correct: 'B' },
          { question: 'Why do many young people combine studies with part-time jobs?', options: ['A. To avoid studying', 'B. To gain practical experience', 'C. To meet new friends'], correct: 'B' },
          { question: 'What influences career choice in Germany?', options: ['A. Only job opportunities', 'B. Only personal interests', 'C. Personal interests and the job market'], correct: 'C' },
          { question: 'What skills are highly sought after in the German job market?', options: ['A. Cooking skills', 'B. Digital skills and foreign languages', 'C. Driving skills'], correct: 'B' }
        ],
        studentGrid: [
          { name: 'Mia', text: 'Ich habe letztes Jahr mein Abitur gemacht und studiere jetzt BWL in K√∂ln. Es ist anspruchsvoll, aber ich finde es super. Nebenbei arbeite ich in einem B√ºro, um mir das Studium zu finanzieren.' },
          { name: 'Tim', text: 'Ich war nicht so der Typ f√ºr die Schule. Nach der Realschule habe ich eine Ausbildung zum Koch angefangen. Ich bin oft im Restaurant und lerne viel von erfahrenen K√∂chen. Das ist viel besser als im Klassenzimmer zu sitzen!' },
          { name: 'Lena', text: 'Ich bin noch in der Oberstufe. Ich √ºberlege, ob ich nach dem Abitur ein FSJ (Freiwilliges Soziales Jahr) mache oder direkt eine duale Ausbildung beginne. Es gibt so viele M√∂glichkeiten.' }
        ],
        gridQuestions: [
          { question: 'Who is working in an office to finance their studies?', correct: 'M' },
          { question: 'Who prefers practical learning over classroom learning?', correct: 'T' },
          { question: 'Who is considering a voluntary social year?', correct: 'L' },
          { question: 'Who is doing an apprenticeship to become a chef?', correct: 'T' },
          { question: 'Who is studying business administration?', correct: 'M' },
          { question: 'Who finds many options after school?', correct: 'L' }
        ],
        openResponseText: 'Die Jugendarbeitslosigkeit ist auch in Deutschland ein Thema, wenn auch nicht so ausgepr√§gt wie in anderen L√§ndern. Der duale Ausbildungssystem ist weltweit bekannt und sehr erfolgreich, da es Theorie und Praxis optimal verbindet. Dies hilft Jugendlichen, direkt nach der Ausbildung einen Job zu finden. Die Digitalisierung ver√§ndert viele Berufe, und lebenslanges Lernen wird immer wichtiger. Programme zur Berufsorientierung unterst√ºtzen Sch√ºler bei der Entscheidungsfindung f√ºr ihre Zukunft.',
        openQuestions: [
          { question: 'What system is well-known and successful in Germany for combining theory and practice?', expectedWords: 5, acceptableAnswers: ['dual apprenticeship system', 'dual training system', 'the dual apprenticeship system'] },
          { question: 'What helps young people find a job directly after training?', expectedWords: 6, acceptableAnswers: ['dual apprenticeship system helps', 'combining theory and practice helps', 'the dual training system helps'] },
          { question: 'What is changing many professions?', expectedWords: 1, acceptableAnswers: ['digitalization'] },
          { question: 'What is becoming increasingly important?', expectedWords: 2, acceptableAnswers: ['lifelong learning'] },
          { question: 'What helps students with their future career decisions?', expectedWords: 4, acceptableAnswers: ['career guidance programs', 'vocational orientation programs', 'programs for career guidance'] }
        ],
        timeSequenceText: 'Als ich Kind war, wollte ich Tierarzt werden, obwohl ich Angst vor gro√üen Hunden hatte. In der Grundschule mochte ich Sport und Erdkunde am liebsten. Jetzt bin ich in der 10. Klasse und bereite mich auf die Realschulpr√ºfung vor. Danach m√∂chte ich die Fachoberschule besuchen, um mein Fachabitur zu machen. In zwei Jahren plane ich, ein duales Studium im Bereich Informatik zu beginnen. In der Zukunft sehe ich mich als Softwareentwickler in einem internationalen Unternehmen.',
        timeEvents: [
          { event: 'Wanting to become a vet as a child', correct: 'P' },
          { event: 'Preparing for Realschule exams', correct: 'N' },
          { event: 'Planning to attend Fachoberschule', correct: 'F' },
          { event: 'Liking sports and geography best in primary school', correct: 'P' },
          { event: 'Seeing myself as a software developer in an international company', correct: 'F' }
        ],
        headlines: [
          { letter: 'A', text: 'Dual education system remains successful' },
          { letter: 'B', text: 'Digital skills gap in German workforce' },
          { letter: 'C', text: 'Career guidance essential for young people' },
          { letter: 'D', text: 'Rise in international internships for students' },
          { letter: 'E', text: 'Challenges of youth employment in rural areas' },
          { letter: 'F', text: 'Lifelong learning key for future job market' }
        ],
        articles: [
          { text: 'Das duale Ausbildungssystem in Deutschland wird weiterhin als Erfolgsmodell gefeiert, das jungen Menschen den direkten Berufseinstieg erm√∂glicht.', correct: 'A' },
          { text: 'Viele Unternehmen in l√§ndlichen Regionen k√§mpfen damit, qualifizierte junge Fachkr√§fte zu finden und zu halten.', correct: 'E' },
          { text: 'Die Nachfrage nach digitalen Kompetenzen √ºbersteigt oft das Angebot an Fachkr√§ften, was zu einer digitalen Qualifikationsl√ºcke f√ºhrt.', correct: 'B' },
          { text: 'Immer mehr deutsche Studierende entscheiden sich f√ºr Praktika im Ausland, um internationale Erfahrungen zu sammeln.', correct: 'D' },
          { text: 'Experten betonen, dass eine fr√ºhzeitige und umfassende Berufsorientierung entscheidend ist, um Jugendlichen den √úbergang ins Berufsleben zu erleichtern.', correct: 'C' }
        ],
        completionText: 'Bildung und Arbeit sind eng miteinander verbunden. Eine gute Ausbildung ist die Grundlage f√ºr eine erfolgreiche Karriere. Aber der Arbeitsmarkt entwickelt sich st√§ndig weiter, und neue Berufe entstehen. Deshalb ist es wichtig, flexibel zu bleiben und sich st√§ndig weiterzubilden. Arbeitgeber suchen nicht nur nach Qualifikationen, sondern auch nach Soft Skills wie Kreativit√§t und Kommunikationsf√§higkeit. Die F√§higkeit zur Zusammenarbeit und zum lebenslangen Lernen sind daher f√ºr die berufliche Zukunft unerl√§sslich.',
        completionSentences: [
          { incomplete: 'Education and work are closely _____.', correct: 'connected' },
          { incomplete: 'Good education is the _____ for a successful career. (foundation)', correct: 'foundation' },
          { incomplete: 'The job market is constantly _____.', correct: 'evolving' },
          { incomplete: 'Employers look for _____ skills like creativity and communication.', correct: 'soft' },
          { incomplete: 'Lifelong learning is _____ for the professional future.', correct: 'essential' }
        ],
        lifestyleText: 'Ein gesunder Lebensstil umfasst nicht nur Ern√§hrung und Bewegung, sondern auch das mentale Wohlbefinden. In Deutschland sind sich junge Menschen zunehmend der Bedeutung bewusst, auf ihre mentale Gesundheit zu achten. Aktivit√§ten wie Meditation, Zeit in der Natur verbringen oder ein Hobby aus√ºben helfen, Stress abzubauen. Es ist ein ganzheitlicher Ansatz, der gute Ern√§hrung, k√∂rperliche Aktivit√§t und emotionale Gesundheit f√ºr ein erf√ºlltes Leben kombiniert.',
        lifestyleQuestions: [
          { question: 'What is the foundation for a successful career?', options: ['A. Good connections', 'B. Good education', 'C. Luck'], correct: 'B' },
          { question: 'What is important due to the constantly evolving job market?', options: ['A. To stay in one job', 'B. To remain flexible and constantly educate oneself', 'C. To avoid new technologies'], correct: 'B' },
          { question: 'What kind of skills are employers looking for besides qualifications?', options: ['A. Only hard skills', 'B. Soft skills', 'C. Physical skills'], correct: 'B' },
          { question: 'Name one soft skill mentioned.', options: ['A. Strength', 'B. Creativity', 'C. Speed'], correct: 'B' },
          { question: 'What are essential for the professional future?', options: ['A. High income', 'B. Ability to collaborate and lifelong learning', 'C. Retirement'], correct: 'B' }
        ],
        translations: [
          { es: 'Ich mache dieses Jahr mein Abitur.', fr: 'Je passe mon baccalaur√©at cette ann√©e.', de: 'Ich mache dieses Jahr mein Abitur.', marks: 2, questionNumber: '41.1' },
          { es: 'Ich m√∂chte eine Ausbildung machen.', fr: 'Je voudrais faire un apprentissage.', de: 'Ich m√∂chte eine Ausbildung machen.', marks: 2, questionNumber: '41.2' },
          { es: 'Mein Nebenjob ist im Supermarkt.', fr: 'Mon petit boulot est au supermarch√©.', de: 'Mein Nebenjob ist im Supermarkt.', marks: 2, questionNumber: '41.3' },
          { es: 'Digitale Kompetenzen sind sehr gefragt.', fr: 'Les comp√©tences num√©riques sont tr√®s demand√©es.', de: 'Digitale Kompetenzen sind sehr gefragt.', marks: 2, questionNumber: '41.4' },
          { es: 'Lebenslanges Lernen ist wichtig.', fr: 'L\'apprentissage tout au long de la vie est important.', de: 'Lebenslanges Lernen ist wichtig.', marks: 2, questionNumber: '41.5' }
        ]
      }
    }
  };

  const themeData = variations[theme];
  if (!themeData) {
    console.warn(`No specific variations found for theme: ${theme} - using default German.`);
    return getDefaultGermanVariations();
  }
  const topicData = themeData[topic];
  if (!topicData) {
    console.warn(`No specific variations found for topic: ${topic} under theme ${theme} - using default German.`);
    return getDefaultGermanVariations();
  }
  return topicData;
}

// --- Default German Content for Fallback ---
function getDefaultGermanVariations() {
  return {
    letterMatching: [
      'Ich mache gerne verschiedene Aktivit√§ten in meiner Freizeit.',
      'Ich treibe Sport mit meinen Freunden am Wochenende.',
      'Ich lese interessante B√ºcher in der Stadtbibliothek.',
      'Ich h√∂re Musik, w√§hrend ich meine Hausaufgaben mache.'
    ],
    options: ['Sports', 'Reading', 'Music', 'Art', 'Gaming', 'Cooking'],
    mainText: 'Dies ist ein Beispieltext f√ºr thematische Bewertungen.',
    multipleChoice: [
      { question: 'Beispielfrage?', options: ['A. Option 1', 'B. Option 2', 'C. Option 3'], correct: 'A' }
    ],
    studentGrid: [
      { name: 'Student1', text: 'Beispieltext 1' },
      { name: 'Student2', text: 'Beispieltext 2' },
      { name: 'Student3', text: 'Beispieltext 3' }
    ],
    gridQuestions: [
      { question: 'Beispielfrage?', correct: 'A' }
    ],
    openResponseText: 'Beispiel f√ºr offene Antwort.',
    openQuestions: [
      { question: 'Beispielfrage?', expectedWords: 2, acceptableAnswers: ['Beispielantwort'] }
    ],
    timeSequenceText: 'Beispiel f√ºr Zeitsequenz.',
    timeEvents: [
      { event: 'Beispielereignis', correct: 'P' }
    ],
    headlines: [
      { letter: 'A', text: 'Beispielschlagzeile' }
    ],
    articles: [
      { text: 'Beispielartikeltext.', correct: 'A' }
    ],
    completionText: 'Beispiel f√ºr Vervollst√§ndigung.',
    completionSentences: [
      { incomplete: 'Beispiel _____ Satz.', correct: 'vollst√§ndiger' }
    ],
    lifestyleText: 'Beispiel f√ºr Lebensstil.',
    lifestyleQuestions: [
      { question: 'Beispielfrage?', options: ['A. Option 1', 'B. Option 2', 'C. Option 3'], correct: 'A' }
    ],
    translations: [
      { es: 'Ejemplo de traducci√≥n.', fr: 'Exemple de traducci√≥n.', de: 'Beispiel f√ºr √úbersetzung.', marks: 2, questionNumber: '40.1' }
    ]
  };
}


/**
 * Generates German topic questions for a specific topic - ALL 40 QUESTIONS
 * @param {string} theme - The AQA theme ID.
 * @param {string} topic - The AQA topic name.
 * @param {string} assessmentId - The ID of the assessment this question belongs to.
 * @param {'foundation' | 'higher'} level - The difficulty level ('foundation' or 'higher').
 * @returns {Array<AQATopicQuestionDefinition>} An array of question objects.
 */
function generateGermanTopicQuestions(theme: string, topic: string, assessmentId: string, level: 'foundation' | 'higher'): AQATopicQuestionDefinition[] {
  // Topic-specific content variations
  const topicVariations = getGermanTopicVariations(theme, topic);

  return [
    // Questions 1-4: Letter Matching - Topic-focused activities (4 marks)
    {
      question_number: 1,
      question_type: 'letter-matching',
      title: `Questions 1-4: ${topic} - Activities and interests`,
      instructions: `Some German teenagers are talking about activities related to ${topic.toLowerCase()}. Which activity does each person mention? Write the correct letter in each box.`,
      marks: 4,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        students: [
          { name: 'Anna', text: topicVariations.letterMatching[0] },
          { name: 'Max', text: topicVariations.letterMatching[1] },
          { name: 'Lisa', text: topicVariations.letterMatching[2] },
          { name: 'Tom', text: topicVariations.letterMatching[3] }
        ],
        options: [
          { letter: 'A', subject: topicVariations.options[0] }, // Matches letterMatching[0]
          { letter: 'B', subject: topicVariations.options[1] }, // Matches letterMatching[1]
          { letter: 'C', subject: topicVariations.options[2] }, // Matches letterMatching[2]
          { letter: 'D', subject: topicVariations.options[3] }, // Matches letterMatching[3]
          { letter: 'E', subject: topicVariations.options[4] },
          { letter: 'F', subject: topicVariations.options[5] }
        ],
        // Shuffled answers
        correctAnswers: { 'Anna': 'A', 'Max': 'D', 'Lisa': 'B', 'Tom': 'C' }
      }
    },

    // Questions 5-9: Multiple Choice - Topic-focused reading (5 marks)
    {
      question_number: 5,
      question_type: 'multiple-choice',
      title: `Questions 5-9: ${topic}`,
      instructions: `You read this extract about ${topic.toLowerCase()}. Answer the questions by selecting the correct option.`,
      reading_text: topicVariations.mainText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.multipleChoice
      }
    },

    // Questions 10-15: Student Grid - Topic-focused activities (6 marks)
    {
      question_number: 10,
      question_type: 'student-grid',
      title: `Questions 10-15: ${topic} - Student experiences`,
      instructions: `You see an online forum. Some German students are discussing ${topic.toLowerCase()}. Answer the following questions. Write F for Finn, L for Lena, J for Julian.`, // Updated names
      marks: 6,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        students: ['F', 'L', 'J'], // Updated names
        studentTexts: topicVariations.studentGrid,
        questions: topicVariations.gridQuestions
      }
    },

    // Questions 16-20: Open Response - Topic-focused article (5 marks)
    {
      question_number: 16,
      question_type: 'open-response',
      title: `Questions 16-20: ${topic} in Germany`,
      instructions: `You read this extract from an article about ${topic.toLowerCase()} in Germany. Answer the following questions in English.`,
      reading_text: topicVariations.openResponseText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.openQuestions
      }
    },

    // Questions 21-25: Time Sequence - Topic-focused interview (5 marks)
    {
      question_number: 21,
      question_type: 'time-sequence',
      title: `Questions 21-25: Interview about ${topic}`,
      instructions: `A German person talks about their experience with ${topic.toLowerCase()}. When do these events happen according to the article? Write P for something that happened in the past, N for something that is happening now, F for something that is going to happen in the future.`,
      reading_text: topicVariations.timeSequenceText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        events: topicVariations.timeEvents
      }
    },

    // Questions 26-30: Headline Matching - Topic-focused news (5 marks)
    {
      question_number: 26,
      question_type: 'headline-matching',
      title: `Questions 26-30: News headlines about ${topic}`,
      instructions: `Match each news article extract with the correct headline. Write the correct letter in each box.`,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        headlines: topicVariations.headlines,
        articles: topicVariations.articles
      }
    },

    // Questions 31-35: Sentence Completion - Topic-focused article (5 marks)
    {
      question_number: 31,
      question_type: 'sentence-completion',
      title: `Questions 31-35: ${topic}`,
      instructions: `Complete the sentences based on the text. Write the missing words in English.`,
      reading_text: topicVariations.completionText,
      marks: 5,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        sentences: topicVariations.completionSentences
      }
    },

    // Questions 36-40: Multiple Choice - Topic-focused lifestyle (5 marks)
    {
      question_number: 36,
      question_type: 'multiple-choice',
      title: `Questions 36-40: ${topic} and lifestyle`,
      instructions: `Read this article about ${topic.toLowerCase()}. Answer the questions by selecting the correct option.`,
      reading_text: topicVariations.lifestyleText,
      marks: 5, // Changed from 4 to 5 marks
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        questions: topicVariations.lifestyleQuestions
      }
    },

    // Question 41: Translation - Topic-focused sentences (10 marks)
    {
      question_number: 41, // Changed from 40 to 41
      question_type: 'translation',
      title: `Question 41: Translation about ${topic}`, // Changed from 40 to 41
      instructions: `Translate these sentences about ${topic.toLowerCase()} into English.`,
      marks: 10,
      theme: theme,
      topic: topic,
      assessment_id: assessmentId,
      difficulty_rating: level === 'foundation' ? 3 : 4,
      question_data: {
        // Updated to use spread operator
        sentences: topicVariations.translations.map((t: any, i: number) => ({
          ...t, // This ensures all language properties (es, fr, de) are included
          questionNumber: `41.${i + 1}` // Changed from 40 to 41
        }))
      }
    }
  ];
}


// --- Main Function to Generate Topic Assessments ---
async function generateTopicAssessments() {
  try {
    console.log('üöÄ Starting topic assessment generation...');

    // Filter to only Theme 1: People and lifestyle and Topic: Education and work
    const filteredThemes = AQA_THEMES.filter(theme => theme.id === 'Theme 1: People and lifestyle');

    for (const language of languages) {
      for (const tier of tiers) {
        for (const theme of filteredThemes) { // Use filtered themes
          // Filter to the specific topic 'Education and work'
          const filteredTopics = theme.topics.filter(topic => topic === 'Education and work');
          for (const topic of filteredTopics) {
            console.log(`\nüìù Processing ${language.name} ${tier.level} - ${theme.id} - ${topic}...`);

            // Get the next assessment number dynamically
            const nextAssessmentNumber = await getNextAssessmentNumber(language.code, tier.level, theme.id, topic);
            const identifier = `assessment-${nextAssessmentNumber}`;

            console.log(`  Next assessment: ${identifier}`);

            // Create the assessment
            const assessmentData: Omit<AQATopicAssessmentDefinition, 'id' | 'created_at' | 'updated_at'> = {
              title: `AQA GCSE ${language.name} Topic Assessment - ${tier.level.charAt(0).toUpperCase() + tier.level.slice(1)} ${topic} ${nextAssessmentNumber}`,
              description: `Complete AQA-style ${tier.level} topic assessment focused on ${topic} with 40 questions covering all question types.`,
              level: tier.level,
              language: language.code,
              identifier: identifier,
              theme: theme.id,
              topic: topic,
              version: '1.0',
              total_questions: 9, // 9 question groups covering 50 marks
              time_limit_minutes: tier.timeLimit,
              is_active: true
            };

            const newAssessment = await assessmentService.createAssessment(assessmentData);

            if (!newAssessment) {
              console.error(`‚ùå Failed to create ${language.name} ${tier.level} assessment.`);
              continue; // Skip to next iteration if assessment creation failed
            }

            console.log(`  ‚úÖ Created assessment: ${newAssessment.id}`);

            // Generate questions based on language
            let questions: AQATopicQuestionDefinition[] = [];
            switch (language.code) {
              case 'es':
                questions = generateSpanishTopicQuestions(theme.id, topic, newAssessment.id, tier.level);
                break;
              case 'fr':
                questions = generateFrenchTopicQuestions(theme.id, topic, newAssessment.id, tier.level);
                break;
              case 'de':
                questions = generateGermanTopicQuestions(theme.id, topic, newAssessment.id, tier.level);
                break;
              default:
                console.error(`‚ùå Unknown language: ${language.code}`);
                // Clean up the assessment if questions cannot be generated
                await supabase.from('aqa_topic_assessments').delete().eq('id', newAssessment.id);
                continue;
            }

            // Ensure assessment_id is correctly set for each question
            questions = questions.map(q => ({ ...q, assessment_id: newAssessment.id! }));


            const questionsCreated = await assessmentService.createQuestions(questions);

            if (!questionsCreated) {
              console.error(`‚ùå Error inserting questions for ${language.name} ${tier.level}.`);
              // Clean up the assessment if questions failed
              await supabase.from('aqa_topic_assessments').delete().eq('id', newAssessment.id);
              continue;
            }

            console.log(`  ‚úÖ Inserted ${questions.length} question groups (50 total marks)`);
            console.log(`  üéØ ${language.name} ${tier.level} ${topic} ${identifier} completed successfully!`);
          }
        }
      }
    }

    console.log('\nüéâ Topic assessment generation completed!');
    console.log('\nüìä Summary:');

    // Show final count
    for (const language of languages) {
      for (const tier of tiers) {
        const assessments = await assessmentService.getAssessmentsByFilters(tier.level, language.code, 'Theme 1: People and lifestyle', 'Education and work');
        console.log(`  ${language.name} ${tier.level}: ${assessments?.length || 0} topic assessments available for 'Education and work'`);
      }
    }

  } catch (error) {
    console.error('‚ùå Error generating topic assessments:', error);
  }
}

// Run the script
generateTopicAssessments()
  .then(() => {
    console.log('‚úÖ Generation process finished.');
    process.exit(0);
  })
  .catch((error) => {
    console.error('‚ùå Generation process failed with an unhandled error:', error);
    process.exit(1);
  });